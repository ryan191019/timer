cscope 15 /ssd/nachen/openwrt/camelot/package/zmtc/src/wdk -q 0000000629 0000064448
	@ap.c

1 
	~"wdk.h
"

4 
	$wdk_­
(
¬gc
, **
¬gv
)

6 ià(
¬gc
 < 1 ||‡rgc > 2)

9 ià(
	`¡r_equ®
(
¬gv
[0], "scan")) {

10 
	`sy¡em
("ifconfig sta0 up");

12 
	`sy¡em
("iw dev sta0 scan");

13 } ià(
	`¡r_equ®
(
¬gv
[0], "result")) {

17 
	`sy¡em
("cd /;echo scan_results > /proc/wd;cat /proc/wd");

18 
	`dump_fe
("/etc/res");

19 
	`sy¡em
("rm /etc/res");

23 
	}
}

	@cdbreset.c

1 
	~"wdk.h
"

4 
	$wdk_cdb»£t
(
¬gc
, **
¬gv
)

6 ià(
¬gc
 != 0)

9 ià(
	`»move
("/etc/dnsmasq.conf") == 0)

10 
	`LOG
("remove dnsmasq.conf success");

12 
	`LOG
("remove dnsmasq.conf fail");

14 
	`sy¡em
("mtdƒrase mtd1");

17 
	}
}

	@cdbupload.c

2 
	~"wdk.h
"

6 
	efe_fÜm©
 {

7 
	mCDB_UNCOMPRESSED
 = 0,

8 
	mCDB_GZIP
 = 0,

9 
	mCDB_BZIP2
 = 1,

13 
	$Œy_to_uncom´ess
(*
·th
) {

15 
h—d”
[2] = {0};

16 
FILE
 *
å
;

18 
å
 = 
	`fİ’
(
·th
,"rb");

19 ifĞ
å
 =ğ
NULL
 )

21 
	`LOG
("Error open‡nd„ead file");

24 
h—d”
[0] = 
	`fg‘c
(
å
)&0xff;

25 
h—d”
[1] = 
	`fg‘c
(
å
)&0xff;

26 
	`fşo£
(
å
);

28 ià((
h—d”
[0] == '#') && (header[1] == 'C')) {

29 
	`LOG
("CDB‚ormal file");

30 } ià((
h—d”
[0] ==0x1f) && (header[1] ==0x8b)) {

31 
	`LOG
("GZIP format, using zcat");

32 
	`exec_cmd2
("mv % /tmp/cÚfig.1", 
·th
);

33 
	`exec_cmd2
("zÿˆ/tmp/cÚfig.1 > %s", 
·th
);

34 } ià((
h—d”
[0] ==0x42) && (header[1] ==0x5a)) {

35 
	`LOG
("BZIP2 format, using bzcat");

36 
	`exec_cmd2
("mv % /tmp/cÚfig.1", 
·th
);

37 
	`exec_cmd2
("bzÿˆ/tmp/cÚfig.1 > %s", 
·th
);

39 
	`LOG
("not‡ cdb file!");

44 
	}
}

50 
expÜt
 
	gCONTENT_LENGTH
='5468'

51 
expÜt
 
CONTENT_TYPE
='multipart/form-data; boundary=----WebKitFormBoundaryCGtCM4'

52 
expÜt
 
DOCUMENT_ROOT
='/www'

53 
expÜt
 
FILE_ID
='0'

54 
expÜt
 
GATEWAY_INTERFACE
='CGI/1.1'

55 
expÜt
 
HTTP_ACCEPT
='text/html,application/xhtml+xml,application/xml;q=0.9,image'

56 
expÜt
 
HTTP_ACCEPT_ENCODING
='gzip, deflate,†zma'

57 
expÜt
 
HTTP_ACCEPT_LANGUAGE
='en-US,en;q=0.8,zh-CN;q=0.6,zh;q=0.4'

58 
expÜt
 
HTTP_AUTHORIZATION
='Basic YWRtaW46YWRtaW4='

59 
expÜt
 
HTTP_CONNECTION
='keep-alive'

60 
expÜt
 
HTTP_COOKIE
='language=en'

61 
expÜt
 
HTTP_HOST
='192.168.1.169'

62 
expÜt
 
HTTP_REFERER
='http://192.168.1.169/config.htm'

63 
expÜt
 
HTTP_USER_AGENT
='Mozilla/5.0 (Windows NT 5.1) AppleWebKit/537.36 (KHTML,'

64 
expÜt
 
PATH
='/sbin:/usr/sbin:/bin:/usr/bin'

65 
expÜt
 
PWD
='/www'

66 
expÜt
 
QUERY_STRING
=''

67 
expÜt
 
REMOTE_ADDR
='192.168.1.213'

68 
expÜt
 
REMOTE_HOST
='192.168.1.213'

69 
expÜt
 
REMOTE_PORT
='9259'

70 
expÜt
 
REMOTE_USER
='admin'

71 
expÜt
 
REQUEST_METHOD
='PO'

75 
£d
 -
i
 "s/^\('192.168.1.213' '0' \).*\Ğ.*\)$/\1${1}\2/g" /
tmp
/
u¶ßd_¡©e
 2

86 
	$wdk_cdbu¶ßd
(
¬gc
, **
¬gv
)

89 ià(
¬gc
 > 0)

92 
	`upd©e_u¶ßd_¡©e
(
WEB_STATE_ONGOING
);

93 ià(
	`f_exi¡s
("/tmp/config.cdb")) {

94 
	`LOG
("/tmp/config.cdb found, starto update");

96 ià(0 =ğ
	`Œy_to_uncom´ess
("/tmp/config.cdb")) {

98 
	`exec_cmd
("tr -d \"\r\" < /tmp/config.cdb > /tmp/tmp.cdb");

99 
	`exec_cmd
("cp /tmp/tmp.cdb /tmp/config.cdb");

100 
	`exec_cmd
("rm -rf /tmp/tmp.cdb");

102 
	`exec_cmd
("cdb†oad /tmp/config.cdb");

103 
	`exec_cmd
("cdb commit");

104 
	`upd©e_u¶ßd_¡©e
(
WEB_STATE_SUCCESS
);

106 
	`upd©e_u¶ßd_¡©e
(
WEB_STATE_FAILURE
);

109 
	`LOG
("/tmp/config.cdb‚ot found!");

110 
	`upd©e_u¶ßd_¡©e
(
WEB_STATE_FAILURE
);

114 
	}
}

	@debug.c

2 
	~"wdk.h
"

5 
	$´št_sh–l_»suÉ
(*
commªd
)

7 
FILE
 *
å
 = 
NULL
;

8 
»suÉ
[100] = {0};

9 
å
 = 
	`pİ’
(
commªd
, "r");

10 ià(
å
 =ğ
NULL
) {

11 
	`LOG
("Failedo„un command\n" );

15 
	`fg‘s
(
»suÉ
, ÔesuÉ), 
å
è!ğ
NULL
) {

16 
	`´štf
("%s", 
»suÉ
);

18 
	`pşo£
(
å
);

20 
	}
}

23 
	$wdk_debug
(
¬gc
, **
¬gv
)

25 
i
 = 0;

26 
cmd
[100] = {0};

27 
i
 = 0; i < 
¬gc
; i++) {

28 
	`¡rÿt
(
cmd
, 
¬gv
[
i
]);

29 
	`¡rÿt
(
cmd
, " ");

31 
	`´štf
("cmd=%s\n", 
cmd
);

32 ià(
	`¡¾’
(
cmd
) > 0)

33 
	`´št_sh–l_»suÉ
(
cmd
);

36 
	}
}

	@dhcps.c

1 
	~<ùy³.h
>

2 
	~"wdk.h
"

4 
	~"šşude/mtc_lškli¡.h
"

6 
	#DNS_NAME
 "dnsmasq"

	)

7 
	#DNS_CONFILE
 "/tmp/"
DNS_NAME
".cÚf"

	)

8 
	#DNS_LEASEFILE
 "/v¬/run/"
DNS_NAME
".Ëa£s"

	)

10 
	#MYTAG
 "MODIFIED"

	)

12 
	sËa£I‹m


14 *
	maddr
;

15 cÚ¡ *
	mmac
;

16 cÚ¡ *
	mÇme
;

17 cÚ¡ *
	m
;

18 
	mæg
;

19 
	mexp
;

24 
li¡_h—d
 
	mli¡
;

25 
Ëa£I‹m
 
	m™em
;

26 }
	tËa£Li¡Node
;

28 
__©Œibu‹__
 ((
unu£d
)è
	$dhıs_g‘_Ëa£s_num
()

30 
num
 = 0;

31 
FILE
 *
å
;

32 
c
;

34 ifĞ
	`f_exi¡s
(
DNS_LEASEFILE
) ) {

35 
å
 = 
	`fİ’
(
DNS_LEASEFILE
, "r");

36 ià(
å
) {

37 (
c
 = 
	`fg‘c
(
å
)è!ğ
EOF
) {

38 ià(
c
 == '\n') {

39 
num
++;

42 
	`fşo£
(
å
);

46  
num
;

47 
	}
}

49 
__©Œibu‹__
 ((
unu£d
)è
	$dhıs_·r£_dnsmasq_cÚf
(
li¡_h—d
 *
lh
)

52 
Ëa£Li¡Node
 *
node
;

53 
FILE
 *
å
;

54 
buf
[128];

55 *
¬gv
[10];

56 *
addr
;

57 
g
 = 0;

59 ifĞ!
	`f_exi¡s
(
DNS_CONFILE
) ) {

62 ià((
å
 = 
	`fİ’
(
DNS_CONFILE
, "r")è!ğ
NULL
) {

63 
	`Ãw_fg‘s
(
buf
, (buf), 
å
è!ğ
NULL
) {

64 ià(!
g
 && 
	`¡r¡r
(
buf
, 
MYTAG
)) {

65 
g
 = 1;

67 ià(
	`¡r¡r
(
buf
, "dhcp-host=")) {

68 ià((
addr
 = 
	`¡rdup
(
buf
)è=ğ
NULL
)

70 ià(
	`¡r2¬gv
(
addr
+("dhı-ho¡=")-1, 
¬gv
, ',') < 3)

73 ià((
node
 = (
Ëa£Li¡Node
 *)
	`ÿÎoc
(Ö—£Li¡Node), 1)è!ğ
NULL
) {

74 
node
->
li¡
.
Ãxt
 =‚ode->li¡.
´ev
 = &node->list;

75 
node
->
™em
.
addr
 =‡ddr;

76 
node
->
™em
.
mac
 = 
¬gv
[0];

77 
node
->
™em
.
Çme
 = 
¬gv
[1];

78 
node
->
™em
.

 = 
¬gv
[2];

79 
node
->
™em
.
æg
 = 1;

80 
node
->
™em
.
exp
 = 0;

82 
	`li¡_add_
(&
node
->
li¡
, 
lh
);

86 
	`fşo£
(
å
);

88 ià(
g
) {

89 
	`exec_cmd2
("£d -˜'/%s/d' %s", 
MYTAG
, 
DNS_CONFILE
);

90 
	`exec_cmd2
("mtc_cli dns„estart");

94 
	}
}

96 
__©Œibu‹__
 ((
unu£d
)è
	$dhıs_·r£_dnsmasq_Ëa£s
(
li¡_h—d
 *
lh
)

99 
Ëa£Li¡Node
 *
node
;

100 
FILE
 *
å
;

101 
buf
[128];

102 *
¬gv
[10];

103 *
addr
;

105 ifĞ!
	`f_exi¡s
(
DNS_LEASEFILE
) ) {

108 ià((
å
 = 
	`fİ’
(
DNS_LEASEFILE
, "r")è!ğ
NULL
) {

109 
	`Ãw_fg‘s
(
buf
, (buf), 
å
è!ğ
NULL
) {

110 ià((
addr
 = 
	`¡rdup
(
buf
)è=ğ
NULL
)

112 ià(
	`¡r2¬gv
(
addr
, 
¬gv
, ' ') < 4)

115 ià((
node
 = (
Ëa£Li¡Node
 *)
	`ÿÎoc
(Ö—£Li¡Node), 1)è!ğ
NULL
) {

116 
node
->
li¡
.
Ãxt
 =‚ode->li¡.
´ev
 = &node->list;

117 
node
->
™em
.
addr
 =‡ddr;

118 
node
->
™em
.
mac
 = 
¬gv
[1];

119 
node
->
™em
.
Çme
 = 
¬gv
[3];

120 
node
->
™em
.

 = 
¬gv
[2];

121 
node
->
™em
.
æg
 = 0;

122 
node
->
™em
.
exp
 = 
	`©oi
(
¬gv
[0]);

124 
	`li¡_add_
(&
node
->
li¡
, 
lh
);

127 
	`fşo£
(
å
);

131 
	}
}

133 
__©Œibu‹__
 ((
unu£d
)è
	$dhıs_show_Ëa£s
()

138 
	`LIST_HEAD
(
ş›Á
);

139 
li¡_h—d
 *
lh
 = &
ş›Á
;

140 
li¡_h—d
 *
pos
, *
Ãxt
;

141 
Ëa£Li¡Node
 *
node
, *
Âode
;

142 
Ëa£I‹m
 
™em
;

143 
»³©
 = 0;

145 
	`dhıs_·r£_dnsmasq_cÚf
(
lh
);

146 
	`dhıs_·r£_dnsmasq_Ëa£s
(
lh
);

148 ià(!
	`li¡_em±y
(
lh
)) {

150 
»³©
 = 0;

151 
	`li¡_fÜ_—ch_§ã
(
pos
, 
Ãxt
, 
lh
) {

152 ià(
Ãxt
 !ğ
lh
) {

153 
node
 = (
Ëa£Li¡Node
 *)
	`li¡_’Œy
(
pos
,†—£Li¡Node, 
li¡
);

154 
Âode
 = (
Ëa£Li¡Node
 *)
	`li¡_’Œy
(
Ãxt
,†—£Li¡Node, 
li¡
);

155 ià(
	`¡rcmp
(
node
->
™em
.
mac
, 
Âode
->item.mac) > 0) {

156 
	`memıy
(&
™em
, &
node
->™em, (
Ëa£I‹m
));

157 
	`memıy
(&
node
->
™em
, &
Âode
->™em, (
Ëa£I‹m
));

158 
	`memıy
(&
Âode
->
™em
, &™em, (
Ëa£I‹m
));

160 
»³©
 = 1;

164 } 
»³©
);

166 
	`li¡_fÜ_—ch_§ã
(
pos
, 
Ãxt
, 
lh
) {

167 
node
 = (
Ëa£Li¡Node
 *)
	`li¡_’Œy
(
pos
,†—£Li¡Node, 
li¡
);

168 
	`´štf
("name=%s&ip=%s&mac=%s&flg=%d&exp=%d\n",

169 
node
->
™em
.
Çme
,‚ode->™em.

,‚ode->™em.
mac
,‚ode->™em.
æg
,‚ode->™em.
exp
);

170 
	`li¡_d–
(&
node
->
li¡
);

171 
	`ä“
(
node
->
™em
.
addr
);

172 
	`ä“
(
node
);

177 
	}
}

179 
__©Œibu‹__
 ((
unu£d
)è
	$dhıs_£t
(*
¬gs
)

182 *
¬gv
[10];

183 *
Çme
, *

, *
mac
, *
æg
;

184 *
p
;

186 ifĞ!
	`f_exi¡s
(
DNS_CONFILE
) ) {

190 if((
	`¡r2¬gv
(
¬gs
, 
¬gv
, '&') < 4) ||

191 !
	`¡r_¬g
(
¬gv
, "name=") || !str_arg(argv, "ip=") ||

192 !
	`¡r_¬g
(
¬gv
, "mac=") || !str_arg(argv, "flg=")) {

193 
	`´štf
("%s: sk,‡rgv i nÙ com¶‘e", 
__func__
);

197 
Çme
 = 
	`¡r_¬g
(
¬gv
, "name=");

198 

 = 
	`¡r_¬g
(
¬gv
, "ip=");

199 
mac
 = 
	`¡r_¬g
(
¬gv
, "mac=");

200 
æg
 = 
	`¡r_¬g
(
¬gv
, "flg=");

201 
p
=
mac
; *p; ++pè*°ğ
	`tŞow”
(*p);

203 
	`exec_cmd2
("£d -˜'/dhı-ho¡=%s,.*,%s/d' %s", 
mac
, 

, 
DNS_CONFILE
);

204 ià(!
	`¡rcmp
(
æg
, "1")) {

205 
	`exec_cmd2
("£d -˜'$¨dhı-ho¡=%s,%s,%s' %s", 
mac
, 
Çme
, 

, 
DNS_CONFILE
);

207 
	`exec_cmd2
("echØ% >> %s", 
MYTAG
, 
DNS_CONFILE
);

210 
	}
}

212 
	$wdk_dhıs
(
¬gc
, **
¬gv
)

214 
”r
 = -1;

216 if(
¬gc
 == 1) {

217 ià(
	`¡rcmp
("Ëa£s", 
¬gv
[0]) == 0) {

218 
	`dhıs_show_Ëa£s
();

219 
”r
 = 0;

220 } ià(
	`¡rcmp
("num", 
¬gv
[0]) == 0) {

221 
	`´štf
("%d\n", 
	`dhıs_g‘_Ëa£s_num
());

222 
”r
 = 0;

224 } if(
¬gc
 == 2) {

225 ià(
	`¡rcmp
("£t", 
¬gv
[0]) == 0) {

226 
	`dhıs_£t
(
¬gv
[1]);

227 
”r
 = 0;

231 ià(!
”r
) {

235 
	`´štf
("usage:/lib/wdk/dhcps [set/leases/num]\n");

236 
	`´štf
("/lib/wdk/dhcps set‚ame=Client1&ip=192.168.169.100&mac=00:11:22:33:44:55&flg=1\n");

239 
	}
}

	@get_channel.c

2 
	~"wdk.h
"

10 
	$wdk_g‘_chªÃl
(
¬gc
, **
¬gv
)

12 
»suÉ
[100] = {0};

13 ià(
¬gc
 != 0) {

21 
	`g‘_sh–l_»suÉ
("iw dev s0 infØ| g»°chªÃÈ|‡wk '{´šˆ$2}'", 
»suÉ
, (result));

22 ià(
	`¡¾’
(
»suÉ
) > 0) {

23 
	`´štf
("%d", 
	`©oi
(
»suÉ
));

26 
	`g‘_sh–l_»suÉ
("iw dev wÏn0 infØ| g»°chªÃÈ|‡wk '{´šˆ$2}'", 
»suÉ
, (result));

27 ià(
	`¡¾’
(
»suÉ
) > 0) {

28 
	`´štf
("%d", 
	`©oi
(
»suÉ
));

30 
	`´štf
("0");

35 
	}
}

	@http.c

3 
	~"wdk.h
"

8 
	$do_Ïrg•o¡
()

11 
®ive_li¡
[200] = {0};

12 
kl_li¡
[200] = {0};

14 *
WDKUPGRADE_KEEP_ALIVE
 = 
NULL
;

15 ià(
	`f_exi¡s
("/tmp/wdkupgrade_before"))

16 
	`exec_cmd
("/tmp/wdkupgrade_before");

27 
	`¡rÿt
(
®ive_li¡
, "init\\|uhttpd\\|hostapd\\|ash\\|watchdog\\|http\\|ps\\|$$");

28 
WDKUPGRADE_KEEP_ALIVE
 = 
	`g‘’v
("WDKUPGRADE_KEEP_ALIVE");

29 ià(
NULL
 !ğ
WDKUPGRADE_KEEP_ALIVE
) {

30 
	`¡rÿt
(
®ive_li¡
, "\\|");

31 
	`¡rÿt
(
®ive_li¡
, 
WDKUPGRADE_KEEP_ALIVE
);

33 
	`LOG
("Alivli¡ = %s", 
®ive_li¡
);

35 
	`exec_cmd3
(
kl_li¡
, (kl_li¡), "p | g»°-v '%s' |‡wk '{if(NR > 2è´šˆ$1}' |¸'\n' ' ' | x¬g kÈ-9", 
®ive_li¡
);

50 
	`wr™–še
("/proc/sys/vm/drop_caches", "3");

51 
	`exec_cmd
("sync");

53 
	}
}

57 
	$wdk_h‰p
(
¬gc
, **
¬gv
)

59 ià(
¬gc
 != 1)

62 ià(
	`¡rcmp
(
¬gv
[0], "largepost") == 0) {

63 
	`do_Ïrg•o¡
();

64 } ià(
	`¡rcmp
(
¬gv
[0], "peerip") == 0) {

66 *
v®ue
 = 
	`g‘’v
("REMOTE_ADDR");

67 ià(
NULL
 !ğ
v®ue
) {

68 
	`LOG
("REMOTE IP=%s", 
v®ue
);

69 
	`´štf
("%s\n", 
v®ue
);

71 } ià(
	`¡rcmp
(
¬gv
[0], "peermac") == 0) {

72 *
v®ue
 = 
	`g‘’v
("REMOTE_ADDR");

73 
mac
[100] = {0};

74 ià(
NULL
 !ğ
v®ue
) {

75 
	`LOG
("REMOTE IP=%s", 
v®ue
);

76 
	`exec_cmd3
(
mac
, (mac), "ÿˆ/´oc/Ãt/¬°| g»°\"%s\" |‡wk '{´šˆ$4}'", 
v®ue
);

77 ià(
	`¡¾’
(
mac
) > 0)

78 
	`´štf
("%s\n", 
mac
);

84 
	}
}

	@log.c

3 
	~"wdk.h
"

6 
	slog_ma
 {

7 
	mlog_ma_’
;

8 
	mlog_sys_
[100];

9 
	mlog_ma_
[100];

10 
	mlog_ma_addr
[100];

11 
	mlog_ma_£nd
[100];

12 
	mlog_ma_auth
[100];

14 
	mauth_’
[100];

15 
	mu£ºame
[100];

16 
	m·sswÜd
[100];

20 
	#LOGMSG
 "/v¬/log/mes§ges"

	)

21 
log_ma
 
	gg_log_ma
;

26 
	$š™_log
()

28 
g_log_ma
.
log_ma_’
 = 
	`cdb_g‘_št
("$log_mail_en", 0);

29 
	`cdb_g‘
("$log_sys_", 
g_log_ma
.
log_sys_
);

30 
	`cdb_g‘
("$log_ma_", 
g_log_ma
.
log_ma_
);

31 
	`cdb_g‘
("$log_ma_addr", 
g_log_ma
.
log_ma_addr
);

32 
	`cdb_g‘
("$log_ma_£nd", 
g_log_ma
.
log_ma_£nd
);

33 
	`cdb_g‘
("$log_ma_auth", 
g_log_ma
.
log_ma_auth
);

39 ià(
	`¡r¡r
(
g_log_ma
.
log_ma_auth
, "’=1"è!ğ
NULL
) {

40 *
ps
 = 
NULL
;

41 *
un
 = 
NULL
;

42 
g_log_ma
.
log_ma_’
 = 1;

43 
ps
 = 
	`¡r¡r
(
g_log_ma
.
log_ma_auth
, "ps=");

44 ià(
NULL
 =ğ
ps
)

46 
	`¡rıy
(
g_log_ma
.
·sswÜd
, 
ps
+3);

47 *(
ps
 -1) = 0x00;

48 
un
 = 
	`¡r¡r
(
g_log_ma
.
log_ma_auth
, "un=");

49 ià(
NULL
 =ğ
un
)

51 
	`¡rıy
(
g_log_ma
.
u£ºame
, 
un
+3);

55 
	}
}

57 
	$­³nd_sšgË_log
(*
‹mp_fe_Çme
, *
fe_Çme
)

59 
	`exec_cmd2
("echØ\"%s\" >> %s", 
fe_Çme
, 
‹mp_fe_Çme
);

60 
	`exec_cmd2
("ÿˆ% >> %s", 
fe_Çme
, 
‹mp_fe_Çme
);

61 
	}
}

64 
	$­³nd_sy¦og
(*
‹mp_fe_Çme
)

67 
šdex
 = 0;

68 
fe_Çme
[100] = {0};

70 ià(
	`f_exi¡s
(
LOGMSG
))

71 
	`­³nd_sšgË_log
(
‹mp_fe_Çme
, 
LOGMSG
);

74 
	`mem£t
(
fe_Çme
, 0, (file_name));

75 
	`¥rštf
(
fe_Çme
, "%s.%d", 
LOGMSG
, 
šdex
);

76 ià(
	`f_exi¡s
(
fe_Çme
)) {

77 
	`­³nd_sšgË_log
(
‹mp_fe_Çme
, 
fe_Çme
);

81 
šdex
++;

84 
	}
}

104 
	$£nd_log
()

106 
	`LOG
("---->sending†og");

108 
‹mp_fe_Çme
[100] = {0};

109 
fe_h—d”
[1000] = {0};

110 
d©e
[100] = {0};

111 
ma_£nd_»suÉ
[100] = {0};

114 
	`LOG
("mail_en=%d username=%s…assword=%s",

115 
g_log_ma
.
log_ma_’
, g_log_ma.
u£ºame
, g_log_ma.
·sswÜd
);

118 ià(
g_log_ma
.
log_ma_’
 != 1)

121 
	`exec_cmd3
(
d©e
, (date), "date");

124 
	`exec_cmd3
(
‹mp_fe_Çme
, (temp_file_name), "mktemp /tmp/mail.XXXXXXXX");

125 
	`LOG
("gÙem°fÇm%s", 
‹mp_fe_Çme
);

126 
	`¥rštf
(
fe_h—d”
, "To: %s\nFrom: %s\nDate: %s\nSubject: Send Syslog message\n\n"

128 
g_log_ma
.
log_ma_addr
,

129 
g_log_ma
.
log_ma_£nd
,

130 
d©e
);

133 
	`LOG
("h—d” cÚ‹Á = %s", 
fe_h—d”
);

134 
	`wr™•roc
(
‹mp_fe_Çme
, 
fe_h—d”
);

137 
	`­³nd_sy¦og
(
‹mp_fe_Çme
);

144 ià(
g_log_ma
.
auth_’
) {

146 
	`exec_cmd3
(
ma_£nd_»suÉ
, (mail_send_result),

148 
g_log_ma
.
log_ma_£nd
, g_log_ma.
log_ma_
,

149 
g_log_ma
.
u£ºame
, g_log_ma.
·sswÜd
, 
‹mp_fe_Çme
);

150 ià(
	`¡¾’
(
ma_£nd_»suÉ
) > 0)

151 
	`LOG
("ma faed,„esuÉ = %s", 
ma_£nd_»suÉ
);

153 
	`LOG
("This method is‚otested,‚o support!!!");

155 
	`exec_cmd2
("/usr/sbin/sendmail -f %s -S %s -t < %s",

156 
g_log_ma
.
log_ma_£nd
, g_log_ma.
log_ma_
, 
‹mp_fe_Çme
);

160 
	`»move
(
‹mp_fe_Çme
);

161 
	}
}

165 
	$show_sšgË_log
(*
log_fe
)

167 
	`LOG
("---->dum°log:%s", 
log_fe
);

168 
	#CHUNK
 1024

	)

169 
buf
[
CHUNK
];

170 
FILE
 *
fe
;

171 
size_t
 
Ä—d
;

172 
fe
 = 
	`fİ’
(
log_fe
, "r");

173 ià(
fe
) {

174 (
Ä—d
 = 
	`ä—d
(
buf
, 1,  buf, 
fe
)) > 0)

175 
	`fwr™e
(
buf
, 1, 
Ä—d
, 
¡dout
);

176 ià(
	`ã¼Ü
(
fe
)) {

177 
	`LOG
("read†ogƒrror");

179 
	`fşo£
(
fe
);

181 
	}
}

185 
	$show_log
()

187 
šdex
 = 0;

188 
fe_Çme
[100] = {0};

190 ià(
	`f_exi¡s
(
LOGMSG
))

191 
	`show_sšgË_log
(
LOGMSG
);

194 
	`mem£t
(
fe_Çme
, 0, (file_name));

195 
	`¥rštf
(
fe_Çme
, "%s.%d", 
LOGMSG
, 
šdex
);

196 ià(
	`f_exi¡s
(
fe_Çme
)) {

197 
	`show_sšgË_log
(
fe_Çme
);

201 
šdex
++;

203 
	}
}

206 
	$ş—n_log
()

208 
šdex
 = 0;

209 
fe_Çme
[100] = {0};

211 ià(
	`f_exi¡s
(
LOGMSG
)) {

212 ià(
	`»move
(
LOGMSG
) == 0) {

213 
	`LOG
("»movf% sucûss", 
LOGMSG
);

215 
	`LOG
("»movf% çed", 
LOGMSG
);

220 
	`mem£t
(
fe_Çme
, 0, (file_name));

221 
	`¥rštf
(
fe_Çme
, "%s.%d", 
LOGMSG
, 
šdex
);

222 ià(
	`f_exi¡s
(
fe_Çme
)) {

223 ià(
	`»move
(
fe_Çme
) == 0) {

224 
	`LOG
("»movf% sucûss", 
fe_Çme
);

226 
	`LOG
("»movf% çed", 
fe_Çme
);

231 
šdex
++;

234 
	`exec_cmd
("touch /var/log/messages");

235 
	}
}

238 
	$wdk_log
(
¬gc
, **
¬gv
)

240 ià(
¬gc
 != 1)

243 
	`š™_log
();

245 ià(
	`¡r_equ®
(
¬gv
[0] ,"-s"))

246 
	`£nd_log
();

247 ià(
	`¡r_equ®
(
¬gv
[0] ,"-xymta"))

248 
	`show_log
();

249 ià(
	`¡r_equ®
(
¬gv
[0] ,"clean"))

250 
	`ş—n_log
();

252 
	`LOG
("wdk†og failed");

256 
	}
}

	@logconf.c

3 
	~"wdk.h
"

7 
	$wdk_logcÚf
(
¬gc
, **
¬gv
)

9 
log_sys_
[100] = {0};

10 
log_rm_’abË
 = 0;

12 
	`exec_cmd
("killall syslogd");

14 
log_rm_’abË
 = 
	`cdb_g‘_št
("$log_rm_enable", 0);

15 
	`cdb_g‘
("$log_sys_", 
log_sys_
);

16 ià(
	`f_exi¡s
( "/sbin/syslogd")) {

17 ià(1 =ğ
log_rm_’abË
) {

18 
	`LOG
("S¹šg sy¦ogØ%s", 
log_sys_
);

19 
	`exec_cmd2
("sy¦ogd - 1 -L -R %s:514", 
log_sys_
);

24 
	}
}

	@logout.c

2 
	~"wdk.h
"

8 
	$wdk_logout
(
¬gc
, **
¬gv
)

11 
pid
[20] = {0};

12 ià(
¬gc
 != 0) {

16 
	`exec_cmd3
(
pid
, (pid), "cat /tmp/httpd.pid");

17 ià(
	`¡¾’
(
pid
) > 0) {

18 
	`LOG
("KILL:%s", 
pid
);

19 
	`exec_cmd2
("kÈ-HUP %s", 
pid
);

23 
	}
}

	@mangment.c

3 
	~"wdk.h
"

4 
	~"cdb.h
"

18 
	$Œª¦©e_fÜm©
(*
¡ršg_š
, *
¡ršg_out
)

20 *
p1
 = 
NULL
;

21 *
p2
 = 
NULL
;

24 
p1
 = 
	`¡r¡r
(
¡ršg_š
, "user=");

25 
p2
 = 
	`¡r¡r
(
¡ršg_š
, "pass=");

26 *(
p2
 - 1) = 0;

28 ià((
p1
 !ğ
NULL
è&& (
p2
 != NULL)) {

29 
	`¡rÿt
(
¡ršg_out
, "/:");

30 
	`¡rÿt
(
¡ršg_out
, 
p1
 + 5);

31 
	`¡rÿt
(
¡ršg_out
, ":");

32 
	`¡rÿt
(
¡ršg_out
, 
p2
 + 5);

35 
	}
}

42 
	$wdk_mªgm’t
(
¬gc
, **
¬gv
)

44 
h‰pd_cÚfig
[100] = {0};

45 
cdb_cÚfig
[100] = {0};

46 
cdb_cÚfig_Ãw
[100] = {0};

47 
	#HTTD_CONF
 "/tmp/h‰pd.cÚf"

	)

49 ià(
¬gc
 != 0) {

50 
	`LOG
("no‡rgument‚eeded");

55 ià(0 =ğ
	`acûss
(
HTTD_CONF
, 0)) {

56 
	`»adlše
(
HTTD_CONF
, 
h‰pd_cÚfig
, (httpd_config));

57 
	`cdb_g‘
("$sys_u£r1", 
cdb_cÚfig
);

58 
	`Œª¦©e_fÜm©
(
cdb_cÚfig
, 
cdb_cÚfig_Ãw
);

60 
	`LOG
("From http.conf=%s\n cdb=%s\n cdb_new=%s",

61 
h‰pd_cÚfig
, 
cdb_cÚfig
, 
cdb_cÚfig_Ãw
);

63 ià(0 =ğ
	`¡rcmp
(
cdb_cÚfig_Ãw
, 
h‰pd_cÚfig
)) {

64 
	`LOG
("Configuration‡re same.‚othingo be done");

66 
	`LOG
("overriding http.conf...");

67 
	`wr™–še
(
HTTD_CONF
, 
cdb_cÚfig_Ãw
);

70 
	`LOG
("% nÙ found!!!", 
HTTD_CONF
);

74 
	}
}

	@ping.c

3 
	~"wdk.h
"

6 
	$wdk_pšg
(
¬gc
, **
¬gv
)

8 
outbuf
[100] = {0};

9 ià(
¬gc
 != 1) {

13 
	`exec_cmd3
(
outbuf
, (outbuf), "/bš/pšg % -ø1 | sed -À'/£q/s/^.*£q/£q/p'", 
¬gv
[0]);

14 
	`´štf
("%s\n", 
outbuf
);

17 
	}
}

	@reboot.c

3 
	~"wdk.h
"

8 
	$fšd_pid_by_Çme
Ğ* 
ProcName
, * 
foundpid
)

10 
DIR
 *
dœ
;

11 
dœ’t
 *
d
;

12 
pid
, 
i
;

13 *
s
;

14 
²Ën
;

16 
i
 = 0;

17 
foundpid
[0] = 0;

18 
²Ën
 = 
	`¡¾’
(
ProcName
);

21 
dœ
 = 
	`İ’dœ
("/proc");

22 ià(!
dœ
)

24 
	`´štf
("cannot open /proc");

29 (
d
 = 
	`»addœ
(
dœ
)è!ğ
NULL
) {

31 
exe
 [
PATH_MAX
+1];

32 
·th
[
PATH_MAX
+1];

33 
Ën
;

34 
Çm–’
;

37 ià((
pid
 = 
	`©oi
(
d
->
d_Çme
)) == 0) ;

39 
	`¢´štf
(
exe
, Óxe), "/´oc/%s/exe", 
d
->
d_Çme
);

40 ià((
Ën
 = 
	`»adlšk
(
exe
, 
·th
, 
PATH_MAX
)) < 0)

42 
·th
[
Ën
] = '\0';

45 
s
 = 
	`¡¼chr
(
·th
, '/');

46 if(
s
 =ğ
NULL
) ;

47 
s
++;

50 
Çm–’
 = 
	`¡¾’
(
s
);

51 if(
Çm–’
 < 
²Ën
) ;

53 if(!
	`¡ºcmp
(
ProcName
, 
s
, 
²Ën
)) {

55 if(
s
[
²Ën
] == ' ' || s[pnlen] == '\0') {

56 
foundpid
[
i
] = 
pid
;

57 
i
++;

62 
foundpid
[
i
] = 0;

63 
	`şo£dœ
(
dœ
);

67 
	}
}

70 
	$fšd_pid_by_Çme_‹¡
(
¬gc
, *
¬gv
[])

72 
i
, 
rv
, 
pid_t
[128];

73 iàĞ
¬gc
 != 2 )

75 
	`årštf
(
¡dout
,"U§g% ´oúame\n",
¬gv
[0]);

79 
rv
 = 
	`fšd_pid_by_Çme
Ğ
¬gv
[1], 
pid_t
);

80 if(0 =ğ
rv
) {

81 
i
=0; 
pid_t
[i] != 0; i++)

82 
	`´štf
("%d\n", 
pid_t
[
i
]);

86 
	}
}

89 
	$wdk_»boÙ
(
¬gc
, **
¬gv
)

92 
pidof_uh‰pd
[128] = {0};

93 ià(
¬gc
 != 0) {

98 
	`LOG
("System is„ebooting...");

100 
	`exec_cmd
("/etc/init.d/wlan stop");

101 
	`¦“p
(3);

102 ià(0 =ğ
	`fšd_pid_by_Çme
("uh‰pd", 
pidof_uh‰pd
)) {

103 
	`LOG
("klšg uh‰pd…id=%d", 
pidof_uh‰pd
[0]);

104 
	`kl
(
pidof_uh‰pd
[0], 
SIGKILL
);

107 
	`exec_cmd
("/sbin/reboot");

110 
	}
}

	@route.c

1 
	~<ùy³.h
>

2 
	~<¬·/š‘.h
>

3 
	~<Ãtuts.h
>

4 
	~"wdk.h
"

6 
	#NETROUTE_FILE
 "/´oc/Ãt/rou‹"

	)

7 #iâdeà
RTF_UP


9 
	#RTF_UP
 0x0001

	)

10 
	#RTF_GATEWAY
 0x0002

	)

11 
	#RTF_HOST
 0x0004

	)

15 
__©Œibu‹__
 ((
unu£d
)è
	$rou‹_show_¿w
()

18 
d¡_addrbuf
[
INET6_ADDRSTRLEN
+1];

19 
g©e_addrbuf
[
INET6_ADDRSTRLEN
+1];

20 
devÇme
[64];

21 
d
, 
g
, 
m
;

22 
ægs
, 
»f
, 
u£
, 
m‘ric
, 
mtu
, 
wš
, 
œ
;

23 
sockaddr_š
 
s_addr
;

24 
š_addr
 
mask
;

25 
FILE
 *
å
;

27 ifĞ!
	`f_exi¡s
(
NETROUTE_FILE
) ) {

31 
å
 = 
	`fİ’
(
NETROUTE_FILE
, "r");

33 ià(
	`fsÿnf
(
å
, "%*[^\n]\n") < 0) {

34 
ERROR
;

37 
r
;

38 
r
 = 
	`fsÿnf
(
å
, "%63s%lx%lx%X%d%d%d%lx%d%d%d\n",

39 
devÇme
, &
d
, &
g
, &
ægs
, &
»f
, &
u£
, &
m‘ric
, &
m
,

40 &
mtu
, &
wš
, &
œ
);

41 ià(
r
 != 11) {

42 ià((
r
 < 0è&& 
	`ãof
(
å
)) {

47 
	`mem£t
(&
s_addr
, 0, (
sockaddr_š
));

48 
s_addr
.
sš_çmy
 = 
AF_INET
;

49 
s_addr
.
sš_addr
.s_add¸ğ
d
;

50 ià(!
	`š‘_Áİ
Ğ
AF_INET
, (*)&(
s_addr
.
sš_addr
), 
d¡_addrbuf
, (dst_addrbuf) )) {

54 
s_addr
.
sš_addr
.s_add¸ğ
g
;

55 ià(!
	`š‘_Áİ
Ğ
AF_INET
, (*)&(
s_addr
.
sš_addr
), 
g©e_addrbuf
, (gate_addrbuf) )) {

59 
mask
.
s_addr
 = 
m
;

61 ià(!(
ægs
 & 
RTF_UP
)) {

65 
	`´štf
("d¡=%s&nm=%s&gw=%s&æg=U&if=%sNÚe\n", 
d¡_addrbuf
, 
	`š‘_Áß
(
mask
), 
g©e_addrbuf
, 
devÇme
);

69 
ERROR
:

70 
	`fşo£
(
å
);

73 
	}
}

75 
	$wdk_rou‹
(
¬gc
, **
¬gv
)

77 
”r
 = -1;

79 if(
¬gc
 == 1) {

80 ià(
	`¡rcmp
("¿w", 
¬gv
[0]) == 0) {

81 
	`rou‹_show_¿w
();

82 
”r
 = 0;

83 } ià(
	`¡rcmp
("r", 
¬gv
[0]) == 0) {

84 
	`exec_cmd2
("mtc_cli„oute„estart");

85 
”r
 = 0;

89 ià(!
”r
) {

93 
	`´štf
("usage:/lib/wdk/route [raw/rip]\n");

96 
	}
}

	@sleep.c

2 
	~"wdk.h
"

5 
	$wdk_¦“p
(
¬gc
, **
¬gv
)

7 ià(
¬gc
 == 0) {

8 
	`LOG
("sleep for 1000ms");

9 
	`¦“p
(1);

11 } if(
¬gc
 == 1) {

12 
	`LOG
("SË• fÜ %ds", 
	`©oi
(
¬gv
[0])/1000);

13 
	`¦“p
(
	`©oi
(
¬gv
[0])/1000);

18 
	}
}

	@smbc.c

18 
	~"wdk.h
"

21 
	#STATE_UPLOAD
 "/tmp/smbc/u¶ßd"

	)

24 
	$wdk_smbc
(
¬gc
, **
¬gv
)

27 
u¶ßd_cÚ‹Á
[10] = {0};

28 *
fe_fuÎ_dœ
 = 
¬gv
[1];

29 *
£rv”_addr
 = 
¬gv
[2];

30 *
u£r_Çme
 = 
¬gv
[3];

31 *
·ss_wÜd
 = 
¬gv
[4];

33 
fe_dœ
[100] = {0};

34 
fe_Çme
[100] = {0};

35 
smb_commªd
[100] = {0};

36 
smb_»¥Ú£
[100] = {0};

38 
i
 = 0;

41 ià(
¬gc
 == 0)

44 ià(
	`¡r_equ®
(
¬gv
[0], "upload")) {

46 
	`¡rıy
(
fe_dœ
, "/media/");

47 
i
 = 
	`¡¾’
(
fe_fuÎ_dœ
) -1; i > 1; i--) {

48 ià(
fe_fuÎ_dœ
[
i
] == '/') {

49 
	`¡rıy
(
fe_Çme
, 
fe_fuÎ_dœ
+
i
+1);

50 
fe_fuÎ_dœ
[
i
] = 0x00;

51 
	`¡rÿt
(
fe_dœ
, 
fe_fuÎ_dœ
);

56 
	`LOG
("dir=%s‚ame=%s user=%s…ass=%s",

57 
fe_dœ
, 
fe_Çme
, 
u£r_Çme
, 
·ss_wÜd
);

58 
	`wr™–še
(
STATE_UPLOAD
, "0");

59 
	`chdœ
(
fe_dœ
);

61 
	`¥rštf
(
smb_commªd
, "smbclient %s %s -U %s -c \"put %s \"",

62 
£rv”_addr
, 
·ss_wÜd
, 
u£r_Çme
, 
fe_Çme
);

63 
	`LOG
("Samb¨commªd=%s", 
smb_commªd
);

64 
	`exec_cmd3
(
smb_»¥Ú£
, (smb_»¥Ú£), 
smb_commªd
);

65 
	`LOG
("Samb¨»¥Ú£=%s", 
smb_»¥Ú£
);

66 
	`wr™–še
(
STATE_UPLOAD
, "1");

68 } ià(
	`¡r_equ®
(
¬gv
[0], "upload_status")) {

69 
	`»adlše
(
STATE_UPLOAD
 , 
u¶ßd_cÚ‹Á
, (upload_content));

70 
	`´štf
("%s", 
u¶ßd_cÚ‹Á
);

76 
	}
}

	@sta.c

3 
	~"wdk.h
"

6 
	siw_¡a_šfo
 {

8 
	mmac
[20];

9 
	mmode
[20];

10 
	m¿‹
[20];

11 
	msigÇl
[20];

15 
iw_¡a_šfo
 
	gg_¡a_šfo
;

18 
	$couÁ_sub¡r
(*
maš_¡r
, *
sub_¡r
)

20 
couÁ
 = 0;

21 * 
tmp
 = 
maš_¡r
;

23 *
tmp
 !ğ'\0' && (tm°ğ
	`¡r¡r
Ñmp, 
sub_¡r
))) {

24 ++
couÁ
;

25 ++
tmp
;

28  
couÁ
;

29 
	}
}

51 
	$´oûss_Ú–še
(*
¡r
)

55 
lše_couÁ
 = 0;

56 *
tmp
;

58 
lše_couÁ
) {

60 
	`mem£t
(&
g_¡a_šfo
, 0, (g_sta_info));

61 
¡r
[25] = 0x00;

62 
	`¡ºıy
(
g_¡a_šfo
.
mac
, 
¡r
 + 8, (g_sta_info.mac));

65 
tmp
 = 
	`¡r¡r
(
¡r
, "dBm");

66 *(
tmp
 - 1) = 0x00;

67 
tmp
 = 
	`¡r¡r
(
¡r
, "-");

68 
	`¡ºıy
(
g_¡a_šfo
.
sigÇl
 , 
tmp
, (g_¡a_šfo.
mac
));

71 ià(
	`¡r¡r
(
¡r
, "MCS"è!ğ
NULL
) {

72 
	`¡ºıy
(
g_¡a_šfo
.
mode
, "11n",(g_¡a_šfo.
mac
));

73 
tmp
 = 
	`¡r¡r
(
¡r
, "MCS");

74 *(
tmp
 - 1) = 0;

75 
tmp
 = 
	`¡r¡r
(
¡r
, "bitrate");

76 
	`¡ºıy
(
g_¡a_šfo
.
¿‹
, 
tmp
+9,(g_¡a_šfo.
mac
));

78 
	`¡ºıy
(
g_¡a_šfo
.
mode
, "11b/g", (g_¡a_šfo.
mac
));

79 
tmp
 = 
	`¡r¡r
(
¡r
, "bitrate");

80 
	`¡ºıy
(
g_¡a_šfo
.
¿‹
, 
tmp
+9,(g_¡a_šfo.
mac
));

84 
	`´štf
("mac=%s&mode=%s&rate=%s&signal=%s\n",

85 
g_¡a_šfo
.
mac
, g_¡a_šfo.
mode
, g_¡a_šfo.
¿‹
, g_¡a_šfo.
sigÇl
);

92 
lše_couÁ
++;

93 ià(6 =ğ
lše_couÁ
)

94 
lše_couÁ
 = 0;

95 
	}
}

104 
	$wdk_¡a
(
¬gc
, **
¬gv
)

107 
bufãr
[500] = {0};

108 *
‹mp
;

109 ià(
¬gc
 > 0) {

113 
	`exec_cmd3
(
bufãr
, (buffer), "iw dev wlan0 station dump");

114 ià(
	`¡¾’
(
bufãr
) == 0)

117 
‹mp
 = 
bufãr
;

118 
‹mp
)

120 * 
ÃxtLše
 = 
	`¡rchr
(
‹mp
, '\n');

121 ià(
ÃxtLše
)

122 *
ÃxtLše
 = '\0';

123 
	`´oûss_Ú–še
(
‹mp
);

124 ià(
ÃxtLše
)

125 *
ÃxtLše
 = '\n';

126 
‹mp
 = 
ÃxtLše
 ? (ÃxtLše+1è: 
NULL
;

130 
	}
}

	@stapoll.c

8 
	~"wdk.h
"

11 
	$äeq_to_chªÃl
(
äeq
)

14 
chªÃl
 = 0;

16 
äeq
) {

18 
chªÃl
 = 1;

21 
chªÃl
 = 2;

24 
chªÃl
 = 3;

27 
chªÃl
 = 4;

30 
chªÃl
 = 5;

33 
chªÃl
 = 6;

36 
chªÃl
 = 7;

39 
chªÃl
 = 8;

42 
chªÃl
 = 9;

45 
chªÃl
 = 10;

48 
chªÃl
 = 11;

51 
chªÃl
 = 12;

54 
chªÃl
 = 13;

57 
chªÃl
 = 14;

60 
	`LOG
("channel ERROR!\n");

61 
chªÃl
 = 1;

65  
chªÃl
;

66 
	}
}

69 
	$»·œ_chªÃl
()

73 
tmp
[50] = {0};

74 
äeq_cur
 = 0;

75 
äeq_cdb
 = 0;

77 
	`exec_cmd3
(
tmp
, (tmp), "iw dev sta0†ink |grep freq |‡wk '{print $2}'");

78 ià(
	`¡¾’
(
tmp
) == 0) {

79 
	`LOG
("stapoll criticalƒrror 2\n");

82 
äeq_cur
 = 
	`äeq_to_chªÃl
(
	`©oi
(
tmp
));

83 
äeq_cdb
 = 
	`cdb_g‘_št
("$wl_channel", 1);

85 ià(
äeq_cur
 !ğ
äeq_cdb
) {

86 
	`LOG
("chªÃÈnÙƒqu®, Cdb=%d Cur=%d\n", 
äeq_cdb
, 
äeq_cur
);

87 
	`cdb_£t_št
("$wl_chªÃl", 
äeq_cur
);

88 
	`exec_cmd
("/etc/init.d/wlan„estart");

90 
	`LOG
("chªÃÈequ®, Cdb=%d Cur=%d\n", 
äeq_cdb
, 
äeq_cur
);

94 
	}
}

100 
	#STATUS_NOT_CONNECTED
 "NÙ cÚÃùed"

	)

101 
	#STATUS_CONNECTED
 "CÚÃùed"

	)

104 
	$wdk_¡­Şl
(
¬gc
, **
¬gv
)

107 
tmp
[300] = {0};

109 
	`LOG
("wdk_stapoll starting...\n");

111 ià(
¬gc
 != 0) {

112 
	`LOG
("NØ¬gum’ˆÃeded!!!:%s", 
¬gv
[0]);

116 
	`exec_cmd3
(
tmp
, (tmp), "iw dev sta0†ink");

117 ià(
	`¡¾’
(
tmp
) == 0) {

118 
	`LOG
("stapoll criticalƒrror 1\n");

123 ià(
	`¡ºcmp
(
tmp
, 
STATUS_CONNECTED
, 
	`¡¾’
(STATUS_CONNECTED)) == 0) {

124 
	`»·œ_chªÃl
();

126 } ià(
	`¡ºcmp
(
tmp
, 
STATUS_NOT_CONNECTED
, 
	`¡¾’
(STATUS_NOT_CONNECTED)) == 0) {

127 
	`LOG
("Wait...");

128 
	`¦“p
(3);

131 
	`LOG
("stapoll criticalƒrror 3\n");

137 
	}
}

	@status.c

5 
	~"wdk.h
"

9 
	$g‘_wifi_sigÇl
()

11 
İ_wÜk_mode
 = -1;

12 
tmp
[50] = {0};

14 
İ_wÜk_mode
 = 
	`cdb_g‘_št
("$op_work_mode", 0);

15 ià(3 =ğ
İ_wÜk_mode
) {

16 
	`exec_cmd3
(
tmp
, (tmp), "iw dev sta0†ink | grep signal |‡wk '{print $2}'");

17 
	`´štf
("%s\n", 
tmp
);

19 
	`´štf
("\n");

21 
	}
}

24 
	$wdk_¡©us
(
¬gc
, **
¬gv
)

26 ià(
¬gc
 != 1) {

30 ià(
	`¡rcmp
(
¬gv
[0], "wifi_signal") == 0) {

31 
	`g‘_wifi_sigÇl
();

32 } ià(
	`¡rcmp
(
¬gv
[0], "batt_power") == 0) {

33 
	`´štf
("100\n");

37 
	}
}

	@stor.c

3 
	~"wdk.h
"

5 
	#UHTTPD_NAME
 "uh‰pd"

	)

6 
	#UHTTPD_CMDS
 "/u¤/sbš/"
UHTTPD_NAME


	)

8 
	#STOR_ROOT_PATH
 "/medŸ"

	)

9 
	#DISK_INFO_FILE
 "/v¬/diskšfo.txt"

	)

11 
	$g‘_fe_size
(*
dœ
, *
f’ame
)

13 
¡©
 
¡
;

14 
disk_dœ_fuÎ
[100] = {0};

16 
	`¡rÿt
(
disk_dœ_fuÎ
, 
dœ
);

17 
	`¡rÿt
(
disk_dœ_fuÎ
, 
f’ame
);

18 
	`¡©
(
disk_dœ_fuÎ
, &
¡
);

19  
¡
.
¡_size
;

20 
	}
}

24 
	$g‘_fe_size_¡ršg
(*
dœ
, *
f’ame
, *
out_¡ršg
)

26 
fe_size
 = 0;

27 
fe_size
 = 
	`g‘_fe_size
(
dœ
, 
f’ame
);

30 ià(
fe_size
 > 1000*1000*1000) {

31 
	`¥rštf
(
out_¡ršg
,"%0.2fGB", ()
fe_size
/(1000*1000*1000));

33 } ià(
fe_size
 > 1000*1000) {

34 
	`¥rštf
(
out_¡ršg
,"%0.2fMB", ()
fe_size
/(1000*1000));

36 } ià(
fe_size
 > 1000) {

37 
	`¥rštf
(
out_¡ršg
,"%0.2fKB", ()
fe_size
/(1000));

39 
	`¥rštf
(
out_¡ršg
,"%dB", 
fe_size
);

43 
	}
}

46 
	$sÙr_ls_dœ
(*
fe_dœ
, *
dœ_šfo
, *
fe_šfo
)

48 
DIR
 *
d
;

49 
dœ’t
 *
dœ
;

50 
disk_dœ
[100] = {0};

51 
fe_Ëngth
[100] = {0};

54 
	`¡rÿt
(
disk_dœ
, "/media");

55 
	`¡rÿt
(
disk_dœ
, 
fe_dœ
);

57 
	`LOG
("O³nšg %s!!!", 
disk_dœ
);

59 
d
 = 
	`İ’dœ
(
disk_dœ
);

60 ià(
d
)

62 
	`¡rÿt
(
dœ_šfo
, "1/0/../");

63 (
dœ
 = 
	`»addœ
(
d
)è!ğ
NULL
)

65 ià(
dœ
->
d_Çme
[0] == '.')

68 ià(
dœ
->
d_ty³
 =ğ
DT_REG
) {

69 
	`¡rÿt
(
fe_šfo
, "0/");

70 
	`g‘_fe_size_¡ršg
(
disk_dœ
, 
dœ
->
d_Çme
, 
fe_Ëngth
);

71 
	`¡rÿt
(
fe_šfo
, 
fe_Ëngth
);

72 
	`¡rÿt
(
fe_šfo
, "/");

73 
	`¡rÿt
(
fe_šfo
, 
dœ
->
d_Çme
);

74 
	`¡rÿt
(
fe_šfo
, "/");

75 } ià(
dœ
->
d_ty³
 ==
DT_DIR
) {

76 
	`¡rÿt
(
dœ_šfo
, "1/0/");

77 
	`¡rÿt
(
dœ_šfo
, 
dœ
->
d_Çme
);

78 
	`¡rÿt
(
dœ_šfo
, "/");

81 
	`şo£dœ
(
d
);

83 
	`LOG
("NØsuch dœ %s!!!", 
disk_dœ
);

87 
	}
}

116 
	$¡Ü_ls
(*
·th
)

118 
tmp
[100] = {0};

121 
dœ_šfo
[1000] = {0};

122 
fe_šfo
[1000] = {0};

124 
	`LOG
("Disk‚ot…resent");

125 
	`´štf
("NoneDisk");

127 ià(0 !ğ
	`acûss
("/var/diskinfo.txt", 0)) {

133 
	`»adlše
("/v¬/diskšfo.txt", 
tmp
, (tmp));

134 ià(
	`¡¾’
(
tmp
) == 0)

140 ià(
	`¡rcmp
(
¬gv
[0] , "/") == 0) {

141 
	`»adlše
("/v¬/diskšfo.txt", 
tmp
, (tmp));

142 
	`¡rÿt
(
dœ_šfo
, "1/0/");

143 
tmp
[
	`¡¾’
(tmp) -1] = 0;

144 
	`¡rÿt
(
dœ_šfo
, 
tmp
 + 7);

145 
	`¡rÿt
(
dœ_šfo
, "/");

148 
	`sÙr_ls_dœ
(
¬gv
[0], 
dœ_šfo
, 
fe_šfo
);

150 
	`LOG
(">>> %s%s", 
dœ_šfo
, 
fe_šfo
);

152 
	`´štf
("%s%sNÚeDisk", 
dœ_šfo
, 
fe_šfo
);

155 
	}
}

168 
	$¡Ü_rm
(
¬gc
, **
¬gv
)

170 
h—d_dœ
[100] = {0};

171 
fuÎ_dœ
[100] = {0};

172 
fuÎ_¬gv
[1000] = {0};

173 *
p
 = 
fuÎ_¬gv
;

174 *
’d
 = 
p
;

176 
	`¡rıy
(
fuÎ_¬gv
, 
¬gv
[0]);

178 (*
’d
 != ' ') && (*end != 0)) {

179 
’d
++;

181 *
’d
 = 0x00;

183 
	`¡rıy
(
h—d_dœ
, 
p
);

184 
p
 = 
’d
+1;

185 
’d
 = 
p
;

187 
	`LOG
("h—d dœ i %s", 
h—d_dœ
);

190 *
’d
 != '/')

191 
’d
++;

192 *
’d
 = 0;

194 
	`mem£t
(
fuÎ_dœ
, 0, (full_dir));

195 
	`¡rÿt
(
fuÎ_dœ
, "/media");

196 
	`¡rÿt
(
fuÎ_dœ
, 
h—d_dœ
);

197 
	`¡rÿt
(
fuÎ_dœ
, 
p
);

198 
	`LOG
("wÈ»move:%s", 
fuÎ_dœ
);

199 
	`uÆšk
(
fuÎ_dœ
);

201 
’d
++;

202 
p
 = 
’d
;

203 ià(*
’d
 == 0x00)

208 
	}
}

226 
	$wdk_¡Ü
(
¬gc
, **
¬gv
)

228 
»t
 = -1;

230 ià(
¬gc
 < 2) {

231 
	`LOG
("ARGoo†ess\n");

233 ià(
¬gc
 < 3) {

234 
	`LOG
("ARG0=%s.ARG1=%s\n", 
¬gv
[0],‡rgv[1]);

235 ià(!
	`¡rcmp
(
¬gv
[0], "ls")) {

236 
»t
 = 
	`¡Ü_ls
(
¬gv
[1]);

239 ià(
¬gc
 < 4) {

240 
	`LOG
("ARG0=%s.ARG1=%s.ARG2=%s\n", 
¬gv
[0],‡rgv[1],‡rgv[2]);

241 
»t
 = 
	`¡Ü_rm
(
¬gc
-1, 
¬gv
+1);

244  
»t
;

245 
	}
}

	@system.c

4 
	~"wdk.h
"

7 
	$do_Áp
()

9 
sys_Áp_svr1
[100] = {0};

10 
sys_Áp_upd©e
 = 0;

11 
sys_Áp_»Œy
 = 0;

13 
	`cdb_g‘
("$sys_Áp_svr1", 
sys_Áp_svr1
);

14 
sys_Áp_upd©e
 = 
	`cdb_g‘_št
("$sys_ntp_update", 0);

15 
sys_Áp_»Œy
 = 
	`cdb_g‘_št
("$sys_ntp_retry", 0);

18 ià(0 =ğ
sys_Áp_»Œy
)

19 
sys_Áp_»Œy
 = 3;

21 ià(0 =ğ
sys_Áp_upd©e
)

22 
sys_Áp_upd©e
 = 86400;

24 ià(
	`¡¾’
(
sys_Áp_svr1
) == 0) {

25 
	`¡rıy
(
sys_Áp_svr1
, "0.asia.pool.ntp.org");

28 
	`exec_cmd
("killall -q -s 9‚tpclient");

29 
	`exec_cmd2
("start-stop-daemon -S -x /usr/sbin/ntpclient -b -- -l -h %s -c %d -s -i %d",

30 
sys_Áp_svr1
, 
sys_Áp_»Œy
, 
sys_Áp_upd©e
);

31 
	}
}

34 
	$do_ho¡Çme
()

37 
sys_Çme
[100] = {0};

38 
ho¡Çme
[100] = {0};

39 
Ïn_
[50] = {0};

40 
Ïn_ho¡
[50] = {0};

43 
	`cdb_g‘
("$sys_Çme", 
sys_Çme
);

45 
	`exec_cmd3
(
ho¡Çme
, (hostname), "cat /proc/sys/kernel/hostname");

46 ià(
	`¡rcmp
(
ho¡Çme
, 
sys_Çme
) != 0) {

47 
	`LOG
("Setting cdb sys_nameo kernel hostname");

48 
	`exec_cmd2
("echØ-À \"%s\" > /´oc/sys/k”Ãl/ho¡Çme", 
sys_Çme
);

49 ià(
	`¡rcmp
(
ho¡Çme
, "(none)") != 0) {

53 
	`LOG
("Setting /etc/hosts");

54 
	`wr™–še
("/etc/hosts", "127.0.0.1†ocalhost\n");

56 
	`cdb_g‘
("$Ïn_", 
Ïn_
);

57 ià((
	`¡¾’
(
Ïn_
è> 0è&& (¡¾’(
sys_Çme
) > 0)) {

58 
	`¥rštf
(
Ïn_ho¡
, "% %s\n", 
Ïn_
, 
sys_Çme
);

59 
	`LOG
("Aµ’dšg: %s", 
Ïn_ho¡
);

60 
	`­³ndlše
("/‘c/ho¡s", 
Ïn_ho¡
);

65 
	}
}

68 
	$do_timezÚe
()

71 
sys_day_šfo
[20] = {0};

72 
timezÚe
 = 0;

73 
timezÚe_g»p
[200] = {0};

74 
timezÚe_g»p_»suÉ
[200] = {0};

75 *
p0
 = 
NULL
;

76 *
p1
 = 
NULL
;

79 ià(0 !ğ
	`acûss
("/lib/data/timezones.txt", 0)) {

83 
	`cdb_g‘
("$sys_day_šfo", 
sys_day_šfo
);

84 ià(
	`¡¾’
(
sys_day_šfo
) == 0)

87 ià(
	`¡rcmp
(
sys_day_šfo
, "!ERR") == 0)

90 
	`ssÿnf
(
sys_day_šfo
, "tz=%d", &
timezÚe
);

91 
	`LOG
("timezÚe=%d", 
timezÚe
);

92 
	`¥rštf
(
timezÚe_g»p
, "ÿˆ/lib/d©a/timezÚes.txˆ| g»°'\"%d\"'", 
timezÚe
);

93 
	`exec_cmd3
(
timezÚe_g»p_»suÉ
, ÑimezÚe_g»p_»suÉ), 
timezÚe_g»p
);

95 
	`LOG
("TimezÚlše=%s", 
timezÚe_g»p_»suÉ
);

97 
p0
 = 
	`¡r¡r
(
timezÚe_g»p_»suÉ
, ",\"");

98 
p0
 =…0+2;

99 
p1
 = 
p0
;

102 
p1
++;

103 ià((*
p1
 == '"') ||(*p1 == ',') )

106 *
p1
 = '\n';

107 *(
p1
+1) = 0x00;

109 
	`LOG
(">>TimezÚe=%s", 
p0
);

110 
	`wr™–še
("/‘c/TZ", 
p0
);

112 
	}
}

114 
	$do_w©chdog
()

117 
sys_wd_’
 = -1;

118 
sys_wd_idË
 = -1;

120 
sys_wd_’
 = 
	`cdb_g‘_št
("$sys_wd_en", 0);

121 
sys_wd_idË
 = 
	`cdb_g‘_št
("$sys_wd_idle", 0);

123 
	`LOG
("kill watchdog");

124 
	`exec_cmd
("killall watchdog");

125 ià(1 =ğ
sys_wd_’
) {

126 
	`LOG
("S¹šg w©chdog w™h idË=%d", 
sys_wd_idË
);

127 
	`exec_cmd2
("w©chdog -ˆ5 -T %d /dev/w©chdog", 
sys_wd_idË
);

129 
	}
}

131 
	$do_deçuÉ
()

133 
	`do_ho¡Çme
();

134 
	`do_timezÚe
();

135 
	`do_w©chdog
();

136 
	}
}

140 
	$wdk_sy¡em
(
¬gc
, **
¬gv
)

142 ià(
¬gc
 == 0) {

143 
	`do_deçuÉ
();

144 } if(
¬gc
 == 1) {

145 
	`LOG
("Argum’ˆi %s", 
¬gv
[0]);

146 if(
	`¡rcmp
(
¬gv
[0], "ntp") == 0) {

147 
	`do_Áp
();

148 } if(
	`¡rcmp
(
¬gv
[0], "hostname") == 0) {

149 
	`do_ho¡Çme
();

150 } if(
	`¡rcmp
(
¬gv
[0], "timezone") == 0) {

151 
	`do_timezÚe
();

152 } if(
	`¡rcmp
(
¬gv
[0], "watchdog") == 0) {

153 
	`do_w©chdog
();

155 
	`LOG
("Unknown command");

159 
	`LOG
("Unknown command");

164 
	}
}

	@sysupgrade.c

2 
	#_GNU_SOURCE


	)

3 
	~"wdk.h
"

6 
	#SYS_UP_FLASH_EXE
 "/sbš/sysupg¿de"

	)

7 
	#SYS_UP_RAM_EXE
 "/tmp/sysupg¿de"

	)

13 
	$ä“_memÜy
(
®l
)

15 
®ive_li¡
[200] = {0};

16 
kl_li¡
[200] = {0};

17 *
WDKUPGRADE_KEEP_ALIVE
 = 
NULL
;

20 ià(
®l
)

21 
	`¡rÿt
(
®ive_li¡
, "init\\|ash\\|watchdog\\|wdkupgrade\\|ps\\|$$");

23 
	`¡rÿt
(
®ive_li¡
, "init\\|uhttpd\\|hostapd\\|ash\\|watchdog\\|wdkupgrade\\|http\\|ps\\|$$");

25 
WDKUPGRADE_KEEP_ALIVE
 = 
	`g‘’v
("WDKUPGRADE_KEEP_ALIVE");

27 ià(
NULL
 !ğ
WDKUPGRADE_KEEP_ALIVE
) {

28 
	`¡rÿt
(
®ive_li¡
, "\\|");

29 
	`¡rÿt
(
®ive_li¡
, 
WDKUPGRADE_KEEP_ALIVE
);

33 
	`LOG
("F»memÜy‚ow,‡Î=%d", 
®l
);

34 
	`exec_cmd3
(
kl_li¡
, (kl_li¡), "p | g»°-v '%s' |‡wk '{if(NR > 2è´šˆ$1}' |¸'\n' ' ' | x¬g kÈ-9", 
®ive_li¡
);

35 
	`wr™–še
("/proc/sys/vm/drop_caches", "3");

36 
	`exec_cmd
("sync");

39 
	}
}

45 
	$g‘_æash_size
()

47 
æash_size
[100] = {0};

48 
	`exec_cmd3
(
æash_size
, (flash_size), "cat /proc/flash | grep \"firmware\" |‡wk '{print $1}'");

50 ià(
	`¡¾’
(
æash_size
) > 0)

51  
	`©oi
(
æash_size
);

54 
	}
}

61 
	$ÿl_image_size
()

63 
æash_size
[100] = {0};

64 
	`exec_cmd3
(
æash_size
, (flash_size), "wc -c /tmp/firmware |‡wk '{print $1}'");

66 ià(
	`¡¾’
(
æash_size
) > 0)

67  
	`©oi
(
æash_size
);

70 
	}
}

78 
	$ÿl_backup_size
()

86 
loÿl
 
sizes
=`
ÿt
 
$
 {
backup_li¡
} 2> /
dev
/
nuÎ
 | 
»ad
 
fe
;

88 [ -
d
 
$fe
 ] && {

89 
du
 -
s
 
$
 {
fe
} | 
awk
 '{print $1*1024}'

91 
wc
 -
c
 
$
{
fe
} | 
awk
 '{print $1}'

93 
dÚe
`

94 
echo
 "${sizes}" | 
awk
 '{sum += $1} END{print sum}'

98 
	}
}

110 
	$check_fœmw¬e_v”siÚ
()

112 
sw_v”
[100] = {0};

113 
fw_v”
[100] = {0};

115 
	`cdb_g‘
("$sw_v”", 
sw_v”
);

117 
	`exec_cmd3
(
fw_v”
, (fw_ver), "hexdump -s 24 -n 4 -e '\"%%d\"' %s", "/tmp/firmware" );

118 ià(
	`©oi
(
fw_v”
è=ğ©oi(
sw_v”
)) {

119 
	`LOG
("fœmw¬v”siÚ ¬§m%s, qu™ upd©e", 
fw_v”
);

122 
	`LOG
("fœmw¬v”siÚ nÙ sam% !ğ%s, m“ˆthÃed", 
fw_v”
, 
sw_v”
);

126 
	}
}

129 
	$check_æash_size
()

131 
æashSize
 = 
	`g‘_æash_size
();

132 
imageSize
 = 
	`ÿl_image_size
();

133 
backupSize
 = 
	`ÿl_backup_size
();

134 
ËáSize
 = 0;

136 ià(0 =ğ
æashSize
)

137 
æashSize
 = 8388608;

139 
ËáSize
 = 
æashSize
 - 
imageSize
 - 
backupSize
;

141 
	`LOG
(">>>>æashSizğ%dBy‹", 
æashSize
);

142 
	`LOG
(">>>>imageSizğ%dBy‹", 
imageSize
);

143 
	`LOG
(">>>>backupSizğ%dBy‹", 
backupSize
);

144 
	`LOG
(">>>>ËáSizğ%dBy‹", 
ËáSize
);

147 ià((
ËáSize
 > 0è||(
imageSize
 <= 0)) {

152 
	}
}

155 
	$check_b©‹ry_¡©us
()

158 
	`LOG
("No battery,…ass");

160 
	}
}

163 
	$check_pow”lše_¡©us
()

166 
	`LOG
("No…owerline,…ass");

168 
	}
}

172 
	$check_checksum
(*
fœmw¬e_·th
)

174 
chksum
[100] = {0};

175 
hwid
[100] = {0};

177 
	`exec_cmd3
(
hwid
, (hwid), "cat /proc/bootvars | grep id= | cut -d '=' -f 2" );

178 
	`exec_cmd3
(
chksum
, (chksum), "chksum -˜% -h %  -v 1;echØ$?", 
fœmw¬e_·th
, 
hwid
);

179 ià(
	`©oi
(
chksum
) == 1) {

180 
	`LOG
("Firmware File chksum failed!");

183 
	`LOG
("Firmware File chksum…assed!");

186 
	}
}

196 
	$check_fœmw¬e_upg¿de
()

199 
	`LOG
("=======>check_firmware_upgrade for conditions");

200 ià(
	`check_checksum
("/tmp/firmware") == 1)

203 ià(
	`check_fœmw¬e_v”siÚ
() == 1) {

204 
	`LOG
("Cancel upgrade, Firmware Versionhe same!");

209 ià(
	`check_æash_size
() == 0) {

210 
	`LOG
("Cancel upgrade, Flash Space‚otƒnough!!");

214 ià(
	`check_b©‹ry_¡©us
() == 0) {

215 
	`LOG
("Cancel upgrade, Low Battery!!");

219 ià(
	`check_pow”lše_¡©us
() == 0) {

220 
	`LOG
("Cancel upgrade, No Power Line!!");

224 
	`LOG
("=======>check_firmware_upgrade done");

228 
	}
}

232 
	$»boÙ_dœeùly
()

234 
	`LOG
("Reboot Directly!!");

235 
	`exec_cmd
("/sbin/reboot2");

236 
	`¦“p
(1);

237 
	`LOG
("Oops!! Reboot Again!!");

238 
	`exec_cmd
("/sbin/reboot2");

239 
	`exec_cmd
("reboot");

240 
	}
}

242 
	$di§bË_w©chdog
()

244 
	`LOG
( "kill watchdog!");

245 
	`exec_cmd
("killall watchdog");

246 
	}
}

250 
	$befÜe_upg¿de
()

253 ià(
	`f_exi¡s
("/tmp/wdkupgrade_before"))

254 
	`exec_cmd
("/tmp/wdkupgrade_before");

256 
	`ä“_memÜy
(1);

258 ià(
	`f_isdœ
("/overlay/playlists)")) {

259 
	`wr™–še
("/tmp/backup.lst", "/overlay/playlists)");

262 
	`exec_cmd
("cdb„evert");

263 
	`exec_cmd
("cdb commit");

264 
	}
}

266 
	$aá”_upg¿de
()

269 ià(
	`f_exi¡s
("/tmp/wdkupgrade_after")) {

270 
	`exec_cmd
("/tmp/wdkupgrade_after");

273 
	`di§bË_w©chdog
();

274 
	`LOG
("after upgrade: done");

275 
	}
}

282 
	$check_fœmw¬e_h—d”
(*
·th
)

284 
FILE
 *
fw_å
;

285 
k
[3] = {0};

286 
fw_å
=
	`fİ’
(
·th
,"r");

287 
	`ä—d
(
k
,3,1,
fw_å
);

288 
	`fşo£
(
fw_å
);

291 ià((
k
[0] == 0x41) && (k[1] == 0x49) &&

292 (
k
[2] == 0x48))

297 
	}
}

310 
	$check_boÙ_exe
(*
·th
)

312 
FILE
 *
fw_å
;

313 
k
[22] = {0};

314 
fw_å
=
	`fİ’
(
·th
,"r");

315 
	`ä—d
(
k
,22,1,
fw_å
);

316 
	`fşo£
(
fw_å
);

319 ià(
k
[21] &0x10)

323 
	}
}

326 
	$upg¿de_cÜe
()

329 
upd©e_»suÉ
[100] = {0};

335 ià(1 =ğ
	`check_boÙ_exe
("/tmp/firmware")) {

337 
	`LOG
("Updating boot with bootexe..");

338 
	`exec_cmd
("dd if=/tmp/firmware of=/tmp/firmware.tmp bs=1 skip=48; chmod +x /tmp/firmware.tmp; /tmp/firmware.tmp");

340 
	`LOG
("Executing /tmp/sysupgrade");

341 
	`exec_cmd3
(
upd©e_»suÉ
, (update_result), "/tmp/sysupgrade -v -b /tmp/backup.lst /tmp/firmware;echo $?");

344 
	`LOG
("Upd©»suÉ=%s", 
upd©e_»suÉ
);

346 
	}
}

348 
	$¡¬t_upg¿de
(*
dœ
, *
fœmw¬e_Çme
)

350 
cİy_»suÉ
[10] = {0};

351 
fw_·th
[100] = {0};

352 
	`¡rÿt
(
fw_·th
, 
dœ
);

353 
	`¡rÿt
(
fw_·th
, "/");

354 
	`¡rÿt
(
fw_·th
, 
fœmw¬e_Çme
);

356 
	`LOG
("O³Àfœmw¬% tØcheckhh—d”", 
fw_·th
);

357 ià(-1 =ğ(
	`check_fœmw¬e_h—d”
(
fw_·th
))) {

358 
	`LOG
("firmware header check failed");

361 
	`LOG
("firmware header check…assed");

364 
	`ä“_memÜy
(0);

366 
	`LOG
("Cİy fäom % tØ/tmp/fœmw¬e", 
fw_·th
);

367 
	`exec_cmd3
(
cİy_»suÉ
, (cİy_»suÉè, "ı % /tmp/fœmw¬e;echØ$?", 
fw_·th
);

369 ià(
	`¡rcmp
(
cİy_»suÉ
, "0") != 0) {

370 
	`LOG
("Copy file failed");

371 
upd©e_’d
;

375 
	`befÜe_upg¿de
();

376 ià(1 =ğ
	`check_fœmw¬e_upg¿de
()) {

377 
	`LOG
("Firmware Upgrade failed");

378 
upd©e_’d
;

381 
	`upg¿de_cÜe
();

383 
upd©e_’d
:

384 
	`aá”_upg¿de
();

385 
	`¦“p
(3);

386 
	`»boÙ_dœeùly
();

388 
	}
}

391 
	$sÿn_usb_mmc
()

394 
FILE
 *
¡»am
;

395 *
lše
 = 
NULL
;

396 
size_t
 
Ën
 = 0;

397 
ssize_t
 
»ad
;

399 
sys_auto_upg¿de_Çme
[100] = {0};

400 
	`cdb_g‘
("$sys_auto_upg¿de_Çme", 
sys_auto_upg¿de_Çme
);

403 
	`LOG
("Read file content of /var/diskinfo.txt");

404 
¡»am
 = 
	`fİ’
("/var/diskinfo.txt", "r");

405 ià(
¡»am
 =ğ
NULL
) {

406 
	`LOG
("Result shows‚o disk inserted");

410 (
»ad
 = 
	`g‘lše
(&
lše
, &
Ën
, 
¡»am
)) != -1) {

411 
lše
[
	`¡¾’
(line) -1] = 0x00;

412 
	`LOG
("Found stÜagdeviû:%s, s¹Ø£¬ch fÜ %s", 
lše
, 
sys_auto_upg¿de_Çme
);

414 
DIR
 *
d
 = 
NULL
;

415 
dœ’t
 *
dœ
 = 
NULL
;

416 
d
 = 
	`İ’dœ
(
lše
);

417 ià(
d
) {

418 (
dœ
 = 
	`»addœ
(
d
)è!ğ
NULL
) {

419 ià(
dœ
->
d_Çme
[0] == '.')

421 ià((
dœ
->
d_ty³
 =ğ
DT_REG
è&& (
	`¡rcmp
(dœ->
d_Çme
, 
sys_auto_upg¿de_Çme
) == 0)) {

422 
	`LOG
("Found fœmw¬e:%s/%s, s¹Øupg¿de", 
lše
, 
dœ
->
d_Çme
);

423 
	`¡¬t_upg¿de
(
lše
, 
sys_auto_upg¿de_Çme
);

426 
	`şo£dœ
(
d
);

428 
	`LOG
("İ’dœ %  faed,ƒ¼ğ%d", 
lše
, 
”ºo
);

432 
	`LOG
("Search End");

433 
	`ä“
(
lše
);

434 
	`fşo£
(
¡»am
);

436 
	}
}

448 
	$auto_fœmw¬e_upg¿de
(*
·¿
)

450 
sys_auto_upg¿de
 = 0;

452 
sys_auto_upg¿de
 = 
	`cdb_g‘_št
("$sys_auto_upgrade", 0);

454 ià(0 =ğ
sys_auto_upg¿de
) {

455 
	`LOG
("cdb checked sys_auto_upgrade is 0,‡uto upgrade firmwareƒxit");

459 
	`LOG
("Scanning disk for firmware upgrade");

467 
	`sÿn_usb_mmc
();

470 
	}
}

477 
	$web_fœmw¬e_upg¿de
()

480 
fœmw¬e_»ady
 = -1;

481 
	`upd©e_u¶ßd_¡©e
(
WEB_STATE_ONGOING
);

482 
	`ä“_memÜy
(0);

483 
fœmw¬e_»ady
 = 
	`check_fœmw¬e_upg¿de
();

485 ià(
fœmw¬e_»ady
 != 0) {

486 
	`upd©e_u¶ßd_¡©e
(
WEB_STATE_FAILURE
);

487 
	`LOG
("check failed, Do‚othing");

488 
upd©e_’d
;

490 
	`upd©e_u¶ßd_¡©e
(
WEB_STATE_FWSTART
);

491 
	`¦“p
(3);

492 
	`befÜe_upg¿de
();

494 
	`LOG
("Writing firmware_fileo flash...");

495 
	`upg¿de_cÜe
();

499 
	`upd©e_u¶ßd_¡©e
(
WEB_STATE_SUCCESS
);

501 
upd©e_’d
:

502 
	`aá”_upg¿de
();

503 
	`¦“p
(3);

504 
	`»boÙ_dœeùly
();

506 
	}
}

517 
	$wdk_sysupg¿de
(
¬gc
, **
¬gv
)

520 
·th
[1024] = {0};

521 
d«mÚ_cmd
[1024] = {0};

522 
i
 = 0;

524 
	`g‘_£lf_·th
(
·th
, (path));

526 
	`LOG
("sysupg¿di cu»Ály‡ˆ%s", 
·th
);

527 ià(
	`¡rcmp
("/lib/wdk/wdk-bš", 
·th
) == 0) {

528 
	`exec_cmd
("cp /sbin/sysupgrade /tmp/sysupgrade");

529 
	`exec_cmd
("cp /lib/wdk/sysupgrade /tmp/wdkupgrade");

531 ià(
	`f_exi¡s
("/lib/wdk/sysupgrade_before")) {

532 
	`exec_cmd
("cp /lib/wdk/sysupgrade_before /tmp/wdkupgrade_before");

533 
	`exec_cmd
("chmod +x /tmp/wdkupgrade_before");

536 ià(
	`f_exi¡s
("/lib/wdk/sysupgrade_after")) {

537 
	`exec_cmd
("cp /lib/wdk/sysupgrade_after /tmp/wdkupgrade_after");

538 
	`exec_cmd
("chmod +x /tmp/wdkupgrade_after");

541 
i
 = 0; i < 
¬gc
; i++) {

542 
	`¡rÿt
(
d«mÚ_cmd
, 
¬gv
[
i
]);

543 
	`¡rÿt
(
d«mÚ_cmd
, " ");

546 
	`LOG
("Pas d«mÚ cmd = %s", 
d«mÚ_cmd
);

547 
	`exec_cmd2
("¡¬t-¡İ-d«mÚ -S -N -10 -x /tmp/wdkupg¿d-b -- %s", 
d«mÚ_cmd
);

548 } ià(
	`¡rcmp
("/tmp/wdkupg¿de", 
·th
) == 0) {

549 ià((
¬gc
 > 1è&& 
	`¡rcmp
(
¬gv
[0], "auto") == 0) {

550 ià(
¬gc
 >= 2) {

551 
	`LOG
("EÁ”‡uto_fœmw¬e_upg¿de,‡rgum’ˆğ%s", 
¬gv
[1]);

552 
	`auto_fœmw¬e_upg¿de
(
¬gv
[1]);

554 
	`LOG
("Enter‡uto_firmware_upgrade");

555 
	`auto_fœmw¬e_upg¿de
(
NULL
);

558 
	`LOG
("Enter web_firmware_upgrade");

559 
	`web_fœmw¬e_upg¿de
();

565 
	}
}

	@time.c

2 
	~"wdk.h
"

18 
	$wdk_time
(
¬gc
, **
¬gv
)

21 
cmd_bufãr
[100] = {0};

22 
d©e_£t_¡r
[100] = {0};

23 
i
 = 0;

24 ià(
¬gc
 == 0) {

25 
	`»adlše
("/´oc/u±ime", 
cmd_bufãr
, (cmd_buffer));

26 
cmd_bufãr
[
i
++] != '.')

28 
cmd_bufãr
[
i
-1] = 0x00;

29 
	`´štf
("%s\n", 
cmd_bufãr
);

30 } ià(
¬gc
 >= 1) {

31 ià(
	`¡rcmp
(
¬gv
[0], "ntp") == 0) {

32 
	`exec_cmd3
(
cmd_bufãr
, (cmd_buffer), "date +%%s");

33 
	`´štf
("%s\n", 
cmd_bufãr
);

34 } ià(
	`¡rcmp
(
¬gv
[0], "ntpstr") == 0) {

35 
	`exec_cmd3
(
cmd_bufãr
, (cmd_buffer), "date +%%c");

36 
	`´štf
("%s\n", 
cmd_bufãr
);

37 } ià(
	`¡rcmp
(
¬gv
[0], "sync") == 0) {

38 
	`exec_cmd3
(
d©e_£t_¡r
, (d©e_£t_¡r), "echØ'' |‡wk '{´šˆ¡ráime(\"%%F %%T\", %s)}'", 
¬gv
[1]);

39 
	`´štf
("%s\n", 
d©e_£t_¡r
);

40 
	`exec_cmd2
("d©- \"%s\"", 
d©e_£t_¡r
);

42 
	`´štf
("Please input„ight…aramenter:[ntpstr/ntp/(empty)]");

47 
	}
}

	@upload.c

4 
	~"wdk.h
"

22 
	$wdk_u¶ßd
(
¬gc
, **
¬gv
)

25 *
REMOTE_ADDR
 = 
NULL
;

26 
u¶ßd_¡©e_£Ëù
[100] = {0};

27 
cu¼’t_¡©e
[10] = {0};

29 ià(
¬gc
 != 2)

32 ià(!
	`¡r_equ®
(
¬gv
[0], "state"))

35 
REMOTE_ADDR
 = 
	`g‘’v
("REMOTE_ADDR");

36 ià(
NULL
 =ğ
REMOTE_ADDR
)

39 
	`¥rštf
(
u¶ßd_¡©e_£Ëù
, "% %s", 
REMOTE_ADDR
, 
¬gv
[1]);

41 
	`exec_cmd3
(
cu¼’t_¡©e
, (current_state),

43 
u¶ßd_¡©e_£Ëù
);

45 
	`LOG
("u¶ßd_¡©e_£Ëù = %s, cu¼’t_¡©eğ%s", 
u¶ßd_¡©e_£Ëù
, 
cu¼’t_¡©e
);

48 ià((
	`©oi
(
cu¼’t_¡©e
è=ğ
WEB_STATE_SUCCESS
) ||

49 (
	`©oi
(
cu¼’t_¡©e
è=ğ
WEB_STATE_FAILURE
)) {

50 
	`exec_cmd2
("£d -˜\"/% /d\" /tmp/u¶ßd_¡©e", 
u¶ßd_¡©e_£Ëù
);

53 ià(
	`¡¾’
(
cu¼’t_¡©e
) > 0)

54 
	`´štf
("%s", 
cu¼’t_¡©e
);

56 
	`´štf
("%d", 
WEB_STATE_DEFAULT
);

60 
	}
}

	@upnp.c

4 
	~"wdk.h
"

27 
	$show_Ëa£
()

29 
Ëa£_lše
[200] = {0};

30 
´Ùo
[100] = {0};

31 
Ÿddr
[100] = {0};

32 
•Üt
[100] = {0};

33 
Üt
[100] = {0};

34 
desc
[100] = {0};

36 *
p
 = 
NULL
;

37 
	`»adlše
("/v¬/Ëa£", 
Ëa£_lše
, (lease_line));

38 
p
 = 
Ëa£_lše
 + 
	`¡¾’
(lease_line) -1;

40 *
p
-- != ':');

41 *(
p
+1) = 0x00;

42 
	`¡rıy
(
desc
, 
p
 + 2);

45 *
p
-- != ':');

46 *(
p
+1) = 0x00;

47 
	`¡rıy
(
Üt
, 
p
 + 2);

49 *
p
-- != ':');

50 *(
p
+1) = 0x00;

51 
	`¡rıy
(
Ÿddr
, 
p
 + 2);

53 *
p
-- != ':');

54 *(
p
+1) = 0x00;

55 
	`¡rıy
(
•Üt
, 
p
 + 2);

57 
	`¡rıy
(
´Ùo
, 
Ëa£_lše
);

59 
	`´štf
("gp=%s&l=%s&Í=%s&´Ù=%s&desc=%s", 
•Üt
, 
Ÿddr
, 
Üt
, 
´Ùo
, 
desc
);

61 
	}
}

63 
	$wdk_u²p
(
¬gc
, **
¬gv
)

65 ià(
¬gc
 == 0)

68 ià(
	`¡rcmp
(
¬gv
[0], "map") == 0) {

69 
	`show_Ëa£
();

73 
	}
}

	@wan.c

1 
	~"wdk.h
"

4 
	$wdk_wª
(
¬gc
, **
¬gv
)

6 ià(
¬gc
 == 0) {

7 
	`´štf
("usage:/lib/wdk/wan [connect/release]\n");

9 } if(
¬gc
 == 1) {

11 
	`pu‹nv
("manual_onoff=1");

13 ià(
	`¡rcmp
("cÚÃù", 
¬gv
[0]) == 0) {

14 
	`exec_cmd
("/etc/init.d/wan stop");

15 
	`exec_cmd
("/etc/init.d/wan start");

16 } ià(
	`¡rcmp
("»Ëa£", 
¬gv
[0]) == 0) {

17 
	`exec_cmd
("/etc/init.d/wan stop");

25 
	}
}

	@wdk.c

1 
	~"wdk.h
"

3 
	gg_log_Ú
;

10 
šlše
 
	$dump_fe
(*
fe_·th
) {

11 
FILE
 *
å
 = 
	`fİ’
(
fe_·th
, "r");

12 
buf
[200] = {0};

13 
	`fg‘s
(
buf
, (buf), 
å
è!ğ
NULL
 ) {

14 
	`´štf
("%s", 
buf
);

16 
	}
}

20 
šlše
 
	$¡r_equ®
(*
¡r1
, *
¡r2
)

22  (
	`¡rcmp
(
¡r1
,
¡r2
) == 0);

23 
	}
}

26 
	$timev®diff
(
timev®
 *
¡¬‰ime
, timev® *
fšishtime
)

28 
m£c
;

29 
m£c
 = (
fšishtime
->
tv_£c
 - 
¡¬‰ime
->tv_sec) * 1000;

30 
m£c
 +ğ(
fšishtime
->
tv_u£c
 - 
¡¬‰ime
->tv_usec) / 1000;

31  
m£c
;

32 
	}
}

34 
	$g‘timev®diff
(
timev®
 *
¡¬t_tv
)

36 
timev®
 
tv
;

37 
timev®
 *
’d_tv
 = &
tv
;

38 
	`g‘timeofday
(
’d_tv
, 
NULL
);

39  
	`timev®diff
(
¡¬t_tv
, 
’d_tv
);

40 
	}
}

42 
	$g‘timeofbegš
(
timev®
 *
¡¬t_tv
)

44 
	`g‘timeofday
(
¡¬t_tv
, 
NULL
);

45 
	}
}

49 
	$g‘_sh–l_»suÉ
(*
commªd
, *
»suÉ
, 
»suÉ_Ën
)

51 
FILE
 *
å
 = 
NULL
;

52 
å
 = 
	`pİ’
(
commªd
, "r");

53 ià(
å
 =ğ
NULL
) {

54 
	`LOG
("Failedo„un command\n" );

57 
	`fg‘s
(
»suÉ
, 
»suÉ_Ën
, 
å
è!ğ
NULL
) {

60 
	`pşo£
(
å
);

62 
	}
}

66 
	$upd©e_u¶ßd_¡©e
(
¡©e
)

68 
FILE
 *
å
 = 
NULL
;

69 *
»mÙe_addr
 = 
NULL
;

70 *
fe_id
 = 
NULL
;

72 
»mÙe_addr
 = 
	`g‘’v
("REMOTE_ADDR");

73 ià(
NULL
 =ğ
»mÙe_addr
)

76 
fe_id
 = 
	`g‘’v
("FILE_ID");

77 ià(
NULL
 =ğ
fe_id
)

80 ifĞ(
å
 = 
	`fİ’
(
WEB_UPLOAD_STATE
, "a+")) ) {

81 
	`årštf
(
å
, "% % %u %u\n", 
»mÙe_addr
, 
fe_id
, 
¡©e
, ()
	`time
(
NULL
));

82 
	`fæush
(
å
);

83 
	`fsync
(
	`f’o
(
å
));

84 
	`fşo£
(
å
);

85 
	`LOG
("%s: s‹=%d ip=% id=%s\n", 
__func__
, 
¡©e
, 
»mÙe_addr
, 
fe_id
);

87 
	}
}

91 
wdk_´og¿m
 
	g´og¿ms
[] = {

94 .
Çme
 = "sleep",

95 .
	gdesütiÚ
 = "sleep for‡ while.\n"

99 .
	gfunùiÚ
 = 
wdk_¦“p
,

102 .
	gÇme
 = "ap",

103 .
	gdesütiÚ
 = "scan or get formatted scan_result\n"

107 .
	gfunùiÚ
 = 
wdk_­
,

110 .
	gÇme
 = "cdbreset",

111 .
	gdesütiÚ
 = "erase mtd1, you‚eedo„eboot‡fterhis operation",

112 .
	gfunùiÚ
 = 
wdk_cdb»£t
,

116 .
	gÇme
 = "debug",

117 .
	gdesütiÚ
 = "debughe command,…rinthe cmd‡nd…rinthe output",

118 .
	gfunùiÚ
 = 
wdk_debug
,

122 .
	gÇme
 = "dhcps",

123 .
	gdesütiÚ
 = "dhcp set/leases/num",

124 .
	gfunùiÚ
 = 
wdk_dhıs
,

128 .
	gÇme
 = "get_channel",

129 .
	gdesütiÚ
 = "get current wifi channel",

130 .
	gfunùiÚ
 = 
wdk_g‘_chªÃl
,

134 .
	gÇme
 = "logout",

135 .
	gdesütiÚ
 = "logout from http??",

136 .
	gfunùiÚ
 = 
wdk_logout
,

140 .
	gÇme
 = "ping",

141 .
	gdesütiÚ
 = "ping‡nd get„esult",

142 .
	gfunùiÚ
 = 
wdk_pšg
,

145 .
	gÇme
 = "reboot",

146 .
	gdesütiÚ
 = "reboot†inux system",

147 .
	gfunùiÚ
 = 
wdk_»boÙ
,

150 .
	gÇme
 = "route",

151 .
	gdesütiÚ
 = "routeable setting",

152 .
	gfunùiÚ
 = 
wdk_rou‹
,

155 .
	gÇme
 = "wan",

156 .
	gdesütiÚ
 = "connect or„elease wan connection",

157 .
	gfunùiÚ
 = 
wdk_wª
,

160 .
	gÇme
 = "mangment",

161 .
	gdesütiÚ
 = "override httpd.conf user‡nd…assword with cdb value",

162 .
	gfunùiÚ
 = 
wdk_mªgm’t
,

166 .
	gÇme
 = "sta",

167 .
	gdesütiÚ
 = "dump current STA(s) connectedohis AP",

168 .
	gfunùiÚ
 = 
wdk_¡a
,

172 .
	gÇme
 = "stor",

173 .
	gdesütiÚ
 = "delete or†s file in Disk Drive",

174 .
	gfunùiÚ
 = 
wdk_¡Ü
,

178 .
	gÇme
 = "stapoll",

179 .
	gdesütiÚ
 = "check current sta0 channel‡nd‡pplyo wlan0 by„estarting service",

180 .
	gfunùiÚ
 =
wdk_¡­Şl
,

184 .
	gÇme
 = "status",

185 .
	gdesütiÚ
 = "gethe status of wifi signal or battery…ower",

186 .
	gfunùiÚ
 =
wdk_¡©us
,

190 .
	gÇme
 = "system",

191 .
	gdesütiÚ
 = "set‚tp,hostname,timezone‡nd watchdog",

192 .
	gfunùiÚ
 =
wdk_sy¡em
,

197 .
	gÇme
 = "http",

198 .
	gdesütiÚ
 = "http",

199 .
	gfunùiÚ
 =
wdk_h‰p
,

204 .
	gÇme
 = "sysupgrade",

205 .
	gdesütiÚ
 = "sysupgrade in /lib/wdk dir",

206 .
	gfunùiÚ
 =
wdk_sysupg¿de
,

211 .
	gÇme
 = "wdkupgrade",

212 .
	gdesütiÚ
 = "sysupgrade inmp dir ",

213 .
	gfunùiÚ
 =
wdk_sysupg¿de
,

217 .
	gÇme
 = "time",

218 .
	gdesütiÚ
 = "get some information ofime ",

219 .
	gfunùiÚ
 =
wdk_time
,

224 .
	gÇme
 = "upnp",

225 .
	gdesütiÚ
 = "get some information of miniupnpd†ease",

226 .
	gfunùiÚ
 =
wdk_u²p
,

230 .
	gÇme
 = "cdbupload",

231 .
	gdesütiÚ
 = "get some information of miniupnpd†ease",

232 .
	gfunùiÚ
 =
wdk_cdbu¶ßd
,

236 .
	gÇme
 = "log",

237 .
	gdesütiÚ
 = "send mailll",

238 .
	gfunùiÚ
 =
wdk_log
,

242 .
	gÇme
 = "logconf",

243 .
	gdesütiÚ
 = "start syslogd",

244 .
	gfunùiÚ
 =
wdk_logcÚf
,

248 .
	gÇme
 = "upload",

249 .
	gdesütiÚ
 = "query upload status",

250 .
	gfunùiÚ
 =
wdk_u¶ßd
,

254 .
	gÇme
 = "wps",

255 .
	gdesütiÚ
 = "wps 0/1 status/button/pin/cancel/genpin",

256 .
	gfunùiÚ
 = 
wdk_wps
,

261 .
	gÇme
 = "smbc",

262 .
	gdesütiÚ
 = "upload†ocal media fileso samba server",

263 .
	gfunùiÚ
 = 
wdk_smbc
,

269 
	$g‘_£lf_·th
(*
buf
, 
Ën
) {

270 
szTmp
[32] = {0};

271 
	`¥rštf
(
szTmp
, "/´oc/%d/exe", 
	`g‘pid
());

272 
by‹s
 = 
	`»adlšk
(
szTmp
, 
buf
, 
Ën
);

273  
by‹s
;

274 
	}
}

276 
	$»adlše
(*
·th
, * 
bufãr
, 
bufãr_size
)

278 
FILE
 * 
å
 = 
NULL
;

279 
å
 = 
	`fİ’
(
·th
, "r");

280 ià(
å
 =ğ
NULL
) {

281 
	`LOG
("İ’ f% çed", 
·th
);

285 if((
	`fg‘s
(
bufãr
, 
bufãr_size
, 
å
))!=
NULL
) {

286 
	`fşo£
(
å
);

289 
	`LOG
("åut f% çed", 
·th
);

290 
	`fşo£
(
å
);

293 
	}
}

295 
	$wr™–še
(*
·th
, * 
bufãr
) {

296 
FILE
 * 
å
 = 
NULL
;

297 
å
 = 
	`fİ’
(
·th
, "w");

298 ià(
å
 =ğ
NULL
) {

299 
	`LOG
("İ’ f% çed", 
·th
);

302 if((
	`åuts
(
bufãr
, 
å
)) >= 0) {

303 
	`fşo£
(
å
);

306 
	`LOG
("åut f% çed", 
·th
);

307 
	`fşo£
(
å
);

310 
	}
}

312 
	$­³ndlše
(*
·th
, * 
bufãr
) {

313 
FILE
 * 
å
 = 
NULL
;

314 
å
 = 
	`fİ’
(
·th
, "a");

315 ià(
å
 =ğ
NULL
) {

316 
	`LOG
("İ’ f% çed", 
·th
);

319 if(
	`åuts
(
bufãr
, 
å
) >= 0) {

320 
	`fşo£
(
å
);

323 
	`LOG
("åut f% çed", 
·th
);

324 
	`fşo£
(
å
);

327 
	}
}

330 
	$’abË_debug
(
’abË
) {

331 ià(
’abË
) {

332 
	`pu‹nv
("WDK_DBG=1");

334 
	`pu‹nv
("WDK_DBG=0");

336 
	}
}

339 
	$check_debug
()

341 
’abË
 = 0;

343 *
v®ue
 = 
	`g‘’v
("WDK_DBG");

344 ià(
NULL
 !ğ
v®ue
) {

345 ià(
	`¡rcmp
(
v®ue
, "1") == 0)

346 
’abË
 = 1;

348  
’abË
;

349 
	}
}

352 
	$debug_Ú
()

354 
g_log_Ú
 = 1;

355 
	}
}

362 
	$´og¿m_exi¡s
(*
´og¿m_Çme
)

364 
DIR
 *
dœ
 = 
NULL
;

365 
dœ’t
 *
dœ_’Œy
;

366 
exi¡
 = 0;

368 
dœ
 = 
	`İ’dœ
("/lib/wdk");

369 ià(
NULL
 !ğ
dœ
) {

370 (
dœ_’Œy
 = 
	`»addœ
(
dœ
)è!ğ
NULL
) {

371 
	`´štf
("\t%s\n", 
dœ_’Œy
->
d_Çme
 );

372 ià(
	`¡rcmp
(
dœ_’Œy
->
d_Çme
, 
´og¿m_Çme
) == 0)

373 
exi¡
 = 1;

375 (è
	`şo£dœ
(
dœ
);

378  
exi¡
;

379 
	}
}

382 
	$´št_avaabË_´og¿m
()

384 
i
 = 0;

385 
i
 = 0; i < (
´og¿ms
)/(programs[0]); i++) {

386 
	`´štf
("* ");

387 
	`´štf
(
´og¿ms
[
i
].
Çme
);

388 
	`´štf
(":\n");

389 
	`´štf
(
´og¿ms
[
i
].
desütiÚ
);

390 
	`´štf
("\n");

392 
	}
}

395 
	$´št_h–p
()

397 
	`´štf
("\nHowo usehis…rogram:\n"

404 
	`´št_avaabË_´og¿m
();

405 
	}
}

417 * 
	$g‘_»®_Çme
(*
fuÎ_Çme
)

419 
i
 = 0;

420 
i
 = 
	`¡¾’
(
fuÎ_Çme
); i > 0 ; i--)

421 ià(
fuÎ_Çme
[
i
] == '/')

422  (
fuÎ_Çme
 + 
i
+1);

423  
fuÎ_Çme
;

424 
	}
}

427 
	$maš
(
¬gc
, *
¬gv
[])

429 
i
 = 0;

430 
found
 = 0;

431 
timev®
 
timecouÁ
;

432 
g_log_Ú
 = 0;

436 ià(
	`check_debug
())

438 
	`debug_Ú
();

441 
i
 = 0; i < (
´og¿ms
)/(programs[0]); i++) {

442 if(
	`¡rcmp
(
´og¿ms
[
i
].
Çme
, 
	`g‘_»®_Çme
(
¬gv
[0])) == 0) {

443 
	`g‘timeofbegš
(&
timecouÁ
);

444 
´og¿ms
[
i
].
	`funùiÚ
(
¬gc
 - 1, 
¬gv
 + 1);

445 
	`LOG
("[%s] s³nd=%ldms", 
´og¿ms
[
i
].
Çme
, 
	`g‘timev®diff
(&
timecouÁ
));

446 
found
 = 1;

451 ià(0 =ğ
found
) {

452 
	`´štf
("NØsuch commªd:%s\n", 
¬gv
[0]);

453 
	`´št_h–p
();

458 
	}
}

	@wdk.h

2 #iâdeà
WDK_H


3 
	#WDK_H


	)

5 
	~<¡ršg.h
>

6 
	~<¡dio.h
>

7 
	~<¡dlib.h
>

8 
	~<uni¡d.h
>

9 
	~<sys/ty³s.h
>

10 
	~<sys/¡©.h
>

11 
	~<sys/wa™.h
>

12 
	~<sys/ioùl.h
>

13 
	~<fú.h
>

14 
	~<”ºo.h
>

15 
	~<dœ’t.h
>

16 
	~<sy¦og.h
>

17 
	~<time.h
>

18 
	~<sigÇl.h
>

20 
	~<cdb.h
>

21 
	~<shuts.h
>

22 
	~<¡ruts.h
>

23 
	~<Ãtuts.h
>

25 
	#WDK_BIN_VERSION
 1

	)

26 
	#PRINT_TO_CONSOLE
 1

	)

29 
	#ırštf
(
fmt
, 
¬gs
...) do { \

30 
FILE
 *
å
 = 
	`fİ’
("/dev/console", "w"); \

31 ià(
å
) { \

32 
	`årštf
(
å
, 
fmt
 , ## 
¬gs
); \

33 
	`fşo£
(
å
); \

35 } 0)

	)

39 #ià
PRINT_TO_CONSOLE


40 
	#LOG
(
fmt
, 
¬gs
...) \

42 ià(
g_log_Ú
) {\

43 
	`ırštf
(
fmt
, ## 
¬gs
); \

44 
	`ırštf
("\n"); \

46 } 0)

	)

48 
	#LOG
(
fmt
, 
¬gs
...) \

50 ià(
g_log_Ú
) \

51 
	`sy¦og
(
LOG_INFO
, 
fmt
, ## 
¬gs
); \

52 } 0)

	)

56 
	swdk_´og¿m
 {

57 *
	mÇme
;

58 *
	mdesütiÚ
;

59 (*
	mfunùiÚ
)(
	m¬gc
, **
	m¬gv
);

65 
g_log_Ú
;

68 
	eweb_¡©e
 {

69 
	mWEB_STATE_DEFAULT
=0,

70 
	mWEB_STATE_ONGOING
=1,

71 
	mWEB_STATE_SUCCESS
=2,

72 
	mWEB_STATE_FAILURE
=3,

73 
	mWEB_STATE_FWSTART
=4,

76 
	#WEB_UPLOAD_STATE
 "/tmp/u¶ßd_¡©e"

	)

79 
dump_fe
(*
fe_·th
);

80 
¡r_equ®
(*
¡r1
, *
¡r2
);

81 
wdk_¦“p
(
¬gc
, **
¬gv
);

82 
wdk_­
(
¬gc
, **
¬gv
);

83 
wdk_cdb»£t
(
¬gc
, **
¬gv
);

84 
wdk_debug
(
¬gc
, **
¬gv
);

85 
wdk_dhıs
(
¬gc
, **
¬gv
);

86 
wdk_g‘_chªÃl
(
¬gc
, **
¬gv
);

87 
wdk_logout
(
¬gc
, **
¬gv
);

88 
wdk_pšg
(
¬gc
, **
¬gv
);

89 
wdk_»boÙ
(
¬gc
, **
¬gv
);

90 
wdk_rou‹
(
¬gc
, **
¬gv
);

91 
wdk_wª
(
¬gc
, **
¬gv
);

92 
wdk_mªgm’t
(
¬gc
, **
¬gv
);

93 
wdk_¡a
(
¬gc
, **
¬gv
);

94 
wdk_¡Ü
(
¬gc
, **
¬gv
);

95 
wdk_¡­Şl
(
¬gc
, **
¬gv
);

96 
wdk_¡©us
(
¬gc
, **
¬gv
);

97 
wdk_sy¡em
(
¬gc
, **
¬gv
);

98 
wdk_sysupg¿de
(
¬gc
, **
¬gv
);

99 
wdk_h‰p
(
¬gc
, **
¬gv
);

100 
wdk_sysupg¿de_befÜe
(
¬gc
, **
¬gv
);

101 
wdk_sysupg¿de_aá”
(
¬gc
, **
¬gv
);

102 
wdk_time
(
¬gc
, **
¬gv
);

103 
wdk_u²p
(
¬gc
, **
¬gv
);

104 
wdk_cdbu¶ßd
(
¬gc
, **
¬gv
);

105 
wdk_log
(
¬gc
, **
¬gv
);

106 
wdk_logcÚf
(
¬gc
, **
¬gv
);

107 
wdk_u¶ßd
(
¬gc
, **
¬gv
);

108 
wdk_wps
(
¬gc
, **
¬gv
);

109 
wdk_smbc
(
¬gc
, **
¬gv
);

115 
»adlše
(*
·th
, * 
bufãr
, 
bufãr_size
);

116 
wr™–še
(*
·th
, * 
bufãr
);

117 
­³ndlše
(*
·th
, * 
bufãr
);

118 
upd©e_u¶ßd_¡©e
(
¡©e
);

121 
g‘_sh–l_»suÉ
(*
commªd
, *
»suÉ
, 
»suÉ_Ën
);

122 
g‘_£lf_·th
(*
buf
, 
Ën
);

	@wps.c

1 
	~<ùy³.h
>

2 
	~"šşude/mtc_ş›Á.h
"

3 
	~"wdk.h
"

6 
	#WPS_RUN
 0

	)

7 
	#WPS_PASS
 1

	)

8 
	#WPS_FAIL
 2

	)

9 
	#WPS_IDLE
 255

	)

12 
	#START
 0

	)

13 
	#MESG
 1

	)

14 
	#FRAG_ACK
 2

	)

15 
	#DONE
 4

	)

16 
	#FAIL
 5

	)

17 
	#IDLE
 255

	)

21 
	#SEND_M1
 0

	)

22 
	#RECV_M2
 1

	)

23 
	#SEND_M3
 2

	)

24 
	#RECV_M4
 3

	)

25 
	#SEND_M5
 4

	)

26 
	#RECV_M6
 5

	)

27 
	#SEND_M7
 6

	)

28 
	#RECV_M8
 7

	)

29 
	#RECEIVED_M2D
 8

	)

30 
	#WPS_MSG_DONE
 9

	)

31 
	#RECV_ACK
 10

	)

32 
	#WPS_FINISHED
 11

	)

33 
	#SEND_WSC_NACK
 12

	)

35 
	#RECV_M1
 13

	)

36 
	#SEND_M2
 14

	)

37 
	#RECV_M3
 15

	)

38 
	#SEND_M4
 16

	)

39 
	#RECV_M5
 17

	)

40 
	#SEND_M6
 18

	)

41 
	#RECV_M7
 19

	)

42 
	#SEND_M8
 20

	)

43 
	#RECV_DONE
 21

	)

44 
	#SEND_M2D
 22

	)

45 
	#RECV_M2D_ACK
 23

	)

48 
	#AUTH_CAP_OPEN
 0x0001

	)

49 
	#AUTH_CAP_SHARED
 0x0002

	)

50 
	#AUTH_CAP_WEP
 0x0004

	)

51 
	#AUTH_CAP_WPA
 0x0008

	)

52 
	#AUTH_CAP_WPA2
 0x0010

	)

53 
	#AUTH_CAP_WPS
 0x0020

	)

54 
	#AUTH_CAP_LEAP
 0x0040

	)

55 
	#AUTH_CAP_WAPI
 0x0080

	)

58 
	#AUTH_CAP_CIPHER_NONE
 0x0000

	)

59 
	#AUTH_CAP_CIPHER_WEP40
 0x0001

	)

60 
	#AUTH_CAP_CIPHER_WEP104
 0x0002

	)

61 
	#AUTH_CAP_CIPHER_TKIP
 0x0004

	)

62 
	#AUTH_CAP_CIPHER_CCMP
 0x0008

	)

63 
	#AUTH_CAP_CIPHER_SMS4
 0x0010

	)

64 
	#AUTH_CAP_CIPHER_AES_128_CMAC
 0x0020

	)

66 
	#HOSTAPD_CLI_BIN
 "/u¤/sbš/ho¡­d_şi"

	)

67 
	#WPS_BSS
 1

	)

69 
	gWPS_AP
[16] = { 0 };

70 *
	gAP
 = 
WPS_AP
;

72 
	$wps_ÿÎback
(*
rbuf
, 
¾’
)

74 *
­
 = 
	`¡r¡r
(
rbuf
, "AP=");

75 
i
 = 0, 
j
 = 3;

77 
	`mem£t
(
WPS_AP
, 0, (WPS_AP));

78 ià(
­
 && ((
rbuf
 ==‡p) || (*(ap-1) == '\n'))) {

79 
i
 < ((
WPS_AP
)-1)) {

80 
WPS_AP
[
i
] = *(
­
 + 
j
);

81 ià((
WPS_AP
[
i
] == '\n') || (WPS_AP[i] == 0)) {

82 
WPS_AP
[
i
] = 0;

85 
i
++;

86 
j
++;

91 
	}
}

93 
__©Œibu‹__
 ((
unu£d
)è
	$wps_g‘_mtc_šfo
()

95 
MtcPkt
 *
·ck‘
;

96 
»t
 = 
RET_ERR
;

98 if((
·ck‘
 = 
	`ÿÎoc
(1, (
MtcPkt
)))) {

99 
·ck‘
->
h—d
.
ifc
 = 
INFC_DAT
;

100 
·ck‘
->
h—d
.
İc
 = 
OPC_DAT_INFO
;

101 
»t
 = 
	`mtc_ş›Á_ÿÎ
(
·ck‘
, 
wps_ÿÎback
);

102 
	`ä“
(
·ck‘
);

105  
»t
;

106 
	}
}

108 
__©Œibu‹__
 ((
unu£d
)è
	$wps_do_bu‰Ú
()

110 
	`wps_g‘_mtc_šfo
();

111 ià(*
AP
) {

112 
	`exec_cmd2
("% -i% wps_pbc", 
HOSTAPD_CLI_BIN
, 
AP
);

113 
	`cdb_£t_št
("$wps_¡©e", 
IDLE
);

114 
	`cdb_£t_št
("$wsc_¡©e", 
START
);

118 
	}
}

120 
__©Œibu‹__
 ((
unu£d
)è
	$wps_do_pš
(*
¬gs
)

122 
buf
[
SSBUF_LEN
] = { 0 };

124 
	`wps_g‘_mtc_šfo
();

125 ià((*
AP
è&& 
	`exec_cmd3
(
buf
, (buf),

126 "% -i% wps_check_pš %s", 
HOSTAPD_CLI_BIN
, 
AP
, 
¬gs
) == 0) {

127 ià(!
	`¡r¡r
(
buf
, "FAIL")) {

128 
	`exec_cmd2
("% -i% wps_pš‡ny %s", 
HOSTAPD_CLI_BIN
, 
AP
, 
¬gs
);

129 
	`cdb_£t_št
("$wps_¡©e", 
IDLE
);

130 
	`cdb_£t_št
("$wsc_¡©e", 
START
);

135 
	}
}

137 
__©Œibu‹__
 ((
unu£d
)è
	$wps_do_g’pš
()

139 
wl_wps_def_pš
[
SSBUF_LEN
] = { 0 };

141 
	`wps_g‘_mtc_šfo
();

142 ià((*
AP
è&& 
	`exec_cmd3
(
wl_wps_def_pš
, (wl_wps_def_pin),

143 "% -i% wps_­_pš„ªdom", 
HOSTAPD_CLI_BIN
, 
AP
) == 0) {

144 ià(!
	`¡r¡r
(
wl_wps_def_pš
, "FAIL")) {

145 
	`cdb_£t
("$wl_wps_def_pš", 
wl_wps_def_pš
);

146 
	`exec_cmd
("/sbin/cdb commit");

151 
	}
}

153 
__©Œibu‹__
 ((
unu£d
)è
	$wps_do_ÿnûl
()

155 
	`wps_g‘_mtc_šfo
();

156 ià(*
AP
) {

157  
	`exec_cmd2
("% -i% wps_ÿnûl", 
HOSTAPD_CLI_BIN
, 
AP
);

161 
	}
}

163 * 
__©Œibu‹__
 ((
unu£d
)è
	$wps_g‘_¡©e_ty³
()

165 
¡©e
[16];

166 
wps_couÁ_down
 = 
	`cdb_g‘_št
("$wps_count_down", 0);

167 
wsc_¡©e
 = 
	`cdb_g‘_št
("$wsc_¡©e", 
IDLE
);

168 
wps_¡©e
 = 0;

170 
	`¡rıy
(
¡©e
, "Run");

172 
wsc_¡©e
) {

173 
FAIL
:

174 
wps_¡©e
 = 
	`cdb_g‘_št
("$wps_¡©e", 
IDLE
);

175 ià((
wps_¡©e
 =ğ
RECV_DONE
è|| (wps_¡©=ğ
RECV_ACK
è|| (wps_¡©=ğ
WPS_MSG_DONE
)) {

176 
	`¡rıy
(
¡©e
, "Pass");

179 
	`¡rıy
(
¡©e
, "Fail");

181 
wps_couÁ_down
--;

182 
	`cdb_£t_št
("$wps_couÁ_down", 
wps_couÁ_down
);

183 ià(
wps_couÁ_down
 <= 0) {

184 
	`cdb_£t_št
("$wps_¡©e", 
IDLE
);

185 
	`cdb_£t_št
("$wsc_¡©e", 
IDLE
);

188 
IDLE
:

189 
	`¡rıy
(
¡©e
, "Idle");

191 
START
:

192 
MESG
:

193 
FRAG_ACK
:

194 
DONE
:

199  
¡©e
;

200 
	}
}

202 
__©Œibu‹__
 ((
unu£d
)è
	$wps_show_¡©us
()

205 
wl_bss_ssid
[
MSBUF_LEN
] = { 0 };

206 
wl_bss_£c_ty³
 = 
	`cdb_g‘_¬¿y_št
("$wl_bss_£c_ty³", 
WPS_BSS
, 0);

207 
wl_bss_ch”
 = 
	`cdb_g‘_¬¿y_št
("$wl_bss_ch”", 
WPS_BSS
, 0);

208 
wl_bss_key_mgt
 = 
	`cdb_g‘_¬¿y_št
("$wl_bss_key_mgt", 
WPS_BSS
, 0);

209 
wl_bss_w•_šdex
 = 
	`cdb_g‘_¬¿y_št
("$wl_bss_w•_šdex", 
WPS_BSS
, 0);

210 
wl_bss_w•_key
[
MSBUF_LEN
] = { 0 };

211 
wl_bss_w·_psk
[
MSBUF_LEN
] = { 0 };

212 
wl_bss_wps_¡©e
 = 
	`cdb_g‘_¬¿y_št
("$wl_bss_wps_¡©e", 
WPS_BSS
, 0);

214 
auth_ÿp_İ’
 = 
wl_bss_£c_ty³
 & 
AUTH_CAP_OPEN
;

215 
auth_ÿp_sh¬ed
 = 
wl_bss_£c_ty³
 & 
AUTH_CAP_SHARED
;

216 
auth_ÿp_w•
 = 
wl_bss_£c_ty³
 & 
AUTH_CAP_WEP
;

217 
auth_ÿp_w·
 = 
wl_bss_£c_ty³
 & 
AUTH_CAP_WPA
;

218 
auth_ÿp_w·2
 = 
wl_bss_£c_ty³
 & 
AUTH_CAP_WPA2
;

219 
auth_ÿp_ch”_tk
 = 
wl_bss_ch”
 & 
AUTH_CAP_CIPHER_TKIP
;

220 
auth_ÿp_ch”_ccmp
 = 
wl_bss_ch”
 & 
AUTH_CAP_CIPHER_CCMP
;

222 
myIdË
[] = "Idle";

223 
key_Ën
 = 0;

224 *
key
 = 
NULL
;

225 *
wps_»suÉ
 = 
NULL
;

226 *
wps_¡©us
 = 
	`wps_g‘_¡©e_ty³
();

228 
	`cdb_g‘_¬¿y_¡r
("$wl_bss_ssid", 
WPS_BSS
, 
wl_bss_ssid
, (wl_bss_ssid), "");

229 
	`cdb_g‘_¬¿y_¡r
("$wl_bss_w•_key", 
wl_bss_w•_šdex
, 
wl_bss_w•_key
, (wl_bss_wep_key), "");

230 
	`cdb_g‘_¬¿y_¡r
("$wl_bss_w·_psk", 
WPS_BSS
, 
wl_bss_w·_psk
, (wl_bss_wpa_psk), "");

232 ià((!
	`¡rcmp
(
wps_¡©us
, "Pass")) || (!strcmp(wps_status, "Fail"))) {

233 
wps_»suÉ
 = 
wps_¡©us
;

234 
wps_¡©us
 = 
myIdË
;

237 
wps_»suÉ
 = 
NULL
;

240 
	`´štf
("STATE=%s,", 
wps_¡©us
);

241 ià(
wl_bss_wps_¡©e
 == 2) {

242 
	`´štf
("CONF=Yes,");

245 
	`´štf
("CONF=No,");

247 
	`´štf
("SSID=%s,", 
wl_bss_ssid
);

248 ià(
wl_bss_key_mgt
 == 0) {

249 
	`´štf
("AUTH=");

250 ià((
auth_ÿp_w·
 > 0è&& (
auth_ÿp_w·2
 > 0)) {

251 
	`´štf
("WPAPSK/WPA2PSK,");

253 ià(
auth_ÿp_w·
 > 0) {

254 
	`´štf
("WPAPSK,");

256 ià(
auth_ÿp_w·2
 > 0) {

257 
	`´štf
("WPA2PSK,");

259 ià(
auth_ÿp_w•
 > 0) {

260 ià(
auth_ÿp_İ’
 > 0) {

261 
	`´štf
("Open,");

263 ià(
auth_ÿp_sh¬ed
 > 0) {

264 
	`´štf
("shared,");

268 
	`´štf
(",");

271 
	`´štf
("ENCR=");

272 ià((
auth_ÿp_ch”_tk
 > 0è&& (
auth_ÿp_ch”_ccmp
 > 0)) {

273 
	`´štf
("TRKP/AES,");

275 ià(
auth_ÿp_ch”_tk
 > 0) {

276 
	`´štf
("TKIP,");

278 ià(
auth_ÿp_ch”_ccmp
 > 0) {

279 
	`´štf
("AES,");

281 ià(
auth_ÿp_w•
 > 0) {

282 
	`´štf
("WEP,");

285 
	`´štf
("None,");

288 
	`´štf
("KEYIDX=%d,", 
wl_bss_w•_šdex
);

289 ià((
auth_ÿp_ch”_tk
 > 0è|| (
auth_ÿp_ch”_ccmp
 > 0)) {

290 
key
 = 
wl_bss_w·_psk
;

292 ià(
auth_ÿp_w•
 > 0) {

293 
key
 = 
wl_bss_w•_key
;

295 ià(
key
) {

296 
key_Ën
 = 
	`¡¾’
(
key
);

297 
	`´štf
("Key=");

298 
key_Ën
-- > 0) {

299 
	`´štf
("%x", *
key
++);

301 
	`´štf
(",");

304 
	`´štf
("Key=,");

309 
	`´štf
("AUTH=,ENCR=,KEYIDX=,KEY=,");

312 
	`´štf
("UUID=,RESULT=%s", (
wps_»suÉ
) ? wps_result : "");

315 
	}
}

317 
	$wdk_wps
(
¬gc
, **
¬gv
)

319 
”r
 = -1;

321 if(
¬gc
 == 2) {

322 ià(
	`¡rcmp
("bu‰Ú", 
¬gv
[1]) == 0) {

323 
	`wps_do_bu‰Ú
();

324 
”r
 = 0;

325 } ià(
	`¡rcmp
("ÿnûl", 
¬gv
[1]) == 0) {

326 
	`wps_do_ÿnûl
();

327 
”r
 = 0;

328 } ià(
	`¡rcmp
("g’pš", 
¬gv
[1]) == 0) {

329 
	`wps_do_g’pš
();

330 
”r
 = 0;

331 } ià(
	`¡rcmp
("¡©us", 
¬gv
[1]) == 0) {

332 
	`wps_show_¡©us
();

333 
”r
 = 0;

335 } if(
¬gc
 == 3) {

336 ià(
	`¡rcmp
("pš", 
¬gv
[1]) == 0) {

337 
	`wps_do_pš
(
¬gv
[2]);

338 
”r
 = 0;

342 ià(!
”r
) {

346 
	`´štf
("usage:/lib/wdk/wps [0|1] [button/pin/cancel/genpin/status]\n");

347 
	`´štf
("/lib/wdk/wps [0|1] [pin…incode]\n");

350 
	}
}

	@
1
.
0
29
241
ap.c
cdbreset.c
cdbupload.c
debug.c
dhcps.c
get_channel.c
http.c
log.c
logconf.c
logout.c
mangment.c
ping.c
reboot.c
route.c
sleep.c
smbc.c
sta.c
stapoll.c
status.c
stor.c
system.c
sysupgrade.c
time.c
upload.c
upnp.c
wan.c
wdk.c
wdk.h
wps.c
